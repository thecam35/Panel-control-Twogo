<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twogo - Transporte Seguro</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYtt3HgpMTfgV-aqwUwEVZ-MKJfPGubWg&libraries=places,geometry&callback=initMap" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>
    
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #ff6b4a;
            --dark: #333;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --background: white;
            --text: #333;
            --card-bg: white;
            --input-bg: #f5f5f5;
        }

        .night-mode {
            --primary: #5d7bff;
            --secondary: #ff7b5a;
            --dark: #f8f9fa;
            --light: #1a1a1a;
            --gray: #a0a0a0;
            --background: #1e1e1e;
            --text: #f8f9fa;
            --card-bg: #2d2d2d;
            --input-bg: #3d3d3d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4a6bff, #3a5bef);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .logo-container {
            margin-bottom: 30px;
            position: relative;
        }
        
        .logo-car {
            width: 120px;
            height: 60px;
            position: relative;
            animation: drive 2s infinite alternate ease-in-out;
        }
        
        .car-body {
            width: 100px;
            height: 40px;
            background: white;
            border-radius: 15px 15px 5px 5px;
            position: absolute;
            top: 10px;
            left: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .car-top {
            width: 70px;
            height: 25px;
            background: white;
            border-radius: 10px 10px 0 0;
            position: absolute;
            top: 0;
            left: 25px;
        }
        
        .car-wheel {
            width: 20px;
            height: 20px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
        }
        
        .car-wheel.front {
            left: 20px;
        }
        
        .car-wheel.back {
            right: 20px;
        }
        
        .car-wheel::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .logo-text {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-top: 20px;
            text-align: center;
        }
        
        .logo-text span {
            color: #ffcc00;
        }
        
        .preloader-message {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .loading-progress {
            height: 100%;
            width: 0%;
            background: white;
            border-radius: 2px;
            animation: loading 3s ease-in-out forwards;
        }
        
        @keyframes drive {
            0% {
                transform: translateX(-10px);
            }
            100% {
                transform: translateX(10px);
            }
        }
        
        @keyframes loading {
            0% {
                width: 0%;
            }
            100% {
                width: 100%;
            }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: var(--card-bg);
            color: var(--text);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid var(--primary);
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.warning {
            border-left-color: #ffc107;
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            color: var(--success);
        }
        
        .toast.warning .toast-icon {
            color: #ffc107;
        }
        
        .toast.error .toast-icon {
            color: var(--danger);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .toast-close:hover {
            background: rgba(0,0,0,0.1);
            color: var(--text);
        }
        
        /* Auth Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            padding: 20px;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .auth-container.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .auth-logo {
            margin-bottom: 30px;
        }
        
        .auth-logo .logo-car {
            width: 80px;
            height: 40px;
            margin: 0 auto;
        }
        
        .auth-logo .logo-text {
            font-size: 28px;
            color: var(--primary);
            margin-top: 10px;
        }
        
        .auth-tabs {
            display: flex;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            background: var(--input-bg);
            border-radius: 10px;
            padding: 5px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text);
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            background: var(--card-bg);
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .auth-form {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-bg);
            border-radius: 8px;
            background: var(--input-bg);
            font-size: 16px;
            color: var(--text);
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .phone-input-container {
            display: flex;
            align-items: center;
        }
        
        .country-code {
            padding: 12px 15px;
            background: var(--input-bg);
            border: 1px solid var(--input-bg);
            border-radius: 8px 0 0 8px;
            color: var(--text);
            font-weight: 600;
        }
        
        .phone-input {
            border-radius: 0 8px 8px 0;
            flex: 1;
        }
        
        .btn-auth {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5bef;
        }
        
        .btn-google {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-google:hover {
            background: #f5f5f5;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--gray);
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--input-bg);
        }
        
        .divider span {
            padding: 0 15px;
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
        }
        
        .auth-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .profile-picture-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--input-bg);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--gray);
            overflow: hidden;
            position: relative;
        }
        
        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .change-photo {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .success-message {
            color: var(--success);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        /* App Styles */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 500px;
            background: var(--background);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 20px;
            transform: translateY(calc(100% - 120px));
            transition: transform 0.3s ease;
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .bottom-sheet.expanded {
            transform: translateY(0);
        }
        
        .drag-handle {
            width: 40px;
            height: 5px;
            background: #ddd;
            border-radius: 3px;
            margin: 0 auto 15px;
            cursor: pointer;
        }
        
        .ride-request-form {
            margin-bottom: 20px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--input-bg);
            border-radius: 10px;
            position: relative;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .pickup-icon {
            background: var(--success);
        }
        
        .destination-icon {
            background: var(--secondary);
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: var(--text);
        }
        
        .location-input input::placeholder {
            color: var(--gray);
        }
        
        .price-slider-container {
            margin: 20px 0;
        }
        
        .price-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .price-value {
            font-weight: bold;
            color: var(--primary);
            font-size: 18px;
        }
        
        .price-slider {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: var(--input-bg);
            border-radius: 5px;
            outline: none;
        }
        
        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .btn-request {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-request:hover {
            background: #3a5bef;
        }
        
        .offers-panel {
            display: none;
            margin-top: 20px;
        }
        
        .offers-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .offer-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--input-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--card-bg);
        }
        
        .offer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }
        
        .driver-rating {
            color: var(--gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .offer-details {
            text-align: right;
        }
        
        .offer-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .offer-time {
            color: var(--gray);
            font-size: 14px;
        }
        
        .btn-accept {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-accept:hover {
            background: #218838;
        }
        
        .ride-in-progress {
            display: none;
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .driver-arrival {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .driver-eta {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .driver-contact {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .contact-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: var(--card-bg);
            border-top: 1px solid var(--input-bg);
        }
        
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .menu-item.active {
            color: var(--primary);
        }
        
        .menu-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .route-info {
            background: var(--card-bg);
            position: absolute;
            top: 80px;
            left: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 600;
            display: none;
            color: var(--text);
        }
        
        .route-duration, .route-distance {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .current-location-btn {
            position: absolute;
            bottom: 140px;
            right: 15px;
            background: var(--card-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
            z-index: 600;
            cursor: pointer;
        }
        
        .map-controls {
            position: absolute;
            top: 80px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 600;
        }
        
        .map-btn {
            background: var(--card-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
            cursor: pointer;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--text);
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .mode-selector {
            display: flex;
            background: var(--input-bg);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text);
        }
        
        .mode-btn.active {
            background: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 600;
            color: var(--primary);
        }
        
        .driver-panel {
            display: none;
        }
        
        .driver-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .driver-name {
            color: var(--text);
        }
        
        .status-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--input-bg);
            border-radius: 15px;
            cursor: pointer;
        }
        
        .status-toggle.active {
            background: var(--success);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .status-toggle.active .toggle-slider {
            transform: translateX(30px);
        }
        
        .ride-request {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .request-details {
            margin-bottom: 15px;
        }
        
        .request-price {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .request-locations {
            font-size: 14px;
            color: var(--gray);
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-accept-request {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-reject-request {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }
        
        .active-ride {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .passenger-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .passenger-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .passenger-name {
            font-weight: 600;
            font-size: 18px;
        }
        
        .ride-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-action {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .stats-grid {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray);
        }

        .api-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .night-mode .api-status {
            background: rgba(30, 30, 30, 0.9);
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }
        
        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .compact-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        .expand-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 16px;
            cursor: pointer;
        }
        
        .location-loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: var(--gray);
        }
        
        .error-panel {
            display: none;
            background: #ffebee;
            color: var(--danger);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }
        
        .night-mode .error-panel {
            background: #3a1f1f;
        }
        
        .retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .google-maps-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            width: 100%;
        }

        .google-maps-btn:hover {
            background: #2d9249;
        }

        .manual-marker-btn {
            position: absolute;
            bottom: 190px;
            right: 15px;
            background: var(--card-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
            z-index: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--card-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
            z-index: 700;
            cursor: pointer;
        }

        .manual-marker-active {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(74, 107, 255, 0.4) !important;
        }

        .address-loading {
            font-size: 12px;
            color: var(--gray);
            font-style: italic;
        }

        .permission-request {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
        }

        .permission-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .permission-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .permission-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text);
        }

        .permission-text {
            color: var(--gray);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .permission-buttons {
            display: flex;
            gap: 15px;
        }

        .btn-permission {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-permission.allow {
            background: var(--primary);
            color: white;
        }

        .btn-permission.deny {
            background: var(--input-bg);
            color: var(--text);
        }
        
        .manual-marker-info {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .manual-marker-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .manual-marker-details {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.4;
        }

        .location-fallback {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            display: none;
        }

        .night-mode .location-fallback {
            background: #3a2f0f;
            border-color: #665a32;
        }

        .location-fallback-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .night-mode .location-fallback-title {
            color: #ffd351;
        }

        .location-fallback-text {
            font-size: 14px;
            color: #856404;
            line-height: 1.4;
        }

        .night-mode .location-fallback-text {
            color: #ffd351;
        }

        .location-retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* Admin Panel Styles */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .admin-panel.active {
            display: flex;
        }

        .admin-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10001;
        }

        .admin-title {
            font-size: 20px;
            font-weight: bold;
        }

        .admin-back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .admin-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        .pending-drivers-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .driver-application {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-app-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .driver-app-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .driver-app-details {
            flex: 1;
        }

        .driver-app-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }

        .driver-app-phone {
            color: var(--gray);
            font-size: 14px;
        }

        .driver-app-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .verified-drivers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .verified-driver-card {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .verified-driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .verified-driver-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }

        .verified-driver-status {
            color: var(--success);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-revoke {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        .no-applications {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }

        .no-applications i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Admin menu item styles */
        .menu-item.admin {
            color: var(--secondary);
        }

        .menu-item.admin .menu-icon {
            color: var(--secondary);
        }

        .menu-item.admin.active {
            color: var(--secondary);
        }

        /* Driver Verification Form Styles - CORREGIDO Y SIMPLIFICADO */
        .verification-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .verification-container.active {
            display: flex;
        }

        .verification-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10001;
        }

        .verification-title {
            font-size: 20px;
            font-weight: bold;
        }

        .verification-back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .verification-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .verification-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .verification-step {
            margin-bottom: 25px;
        }

        .verification-step:last-child {
            margin-bottom: 0;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-title i {
            color: var(--primary);
        }

        .step-description {
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .photo-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .photo-upload-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .photo-upload-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px dashed var(--input-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin: 0 auto;
            position: relative;
        }

        .photo-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload-placeholder {
            text-align: center;
            color: var(--gray);
        }

        .photo-upload-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .photo-upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-upload {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-upload:hover {
            background: #3a5bef;
        }

        .btn-capture {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-capture:hover {
            background: #218838;
        }

        .terms-container {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .terms-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .terms-text {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.5;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            margin-top: 3px;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text);
            line-height: 1.4;
        }

        .checkbox-label a {
            color: var(--primary);
            text-decoration: none;
        }

        .checkbox-label a:hover {
            text-decoration: underline;
        }

        .verification-submit {
            margin-top: 20px;
        }

        .btn-submit-verification {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-submit-verification:hover {
            background: #3a5bef;
        }

        .btn-submit-verification:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        /* Image Modal Styles */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-modal-content img {
            width: 100%;
            height: auto;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 10px;
        }

        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10003;
        }

        /* Driver mode disabled styles */
        .driver-mode-disabled {
            text-align: center;
            padding: 30px 20px;
            background: var(--input-bg);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .disabled-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .disabled-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .disabled-description {
            color: var(--gray);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .btn-apply-verification {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-apply-verification:hover {
            background: #3a5bef;
        }

        /* Hidden file inputs */
        .hidden-file-input {
            display: none;
        }

        /* Driver stats hidden when not verified */
        .driver-stats.hidden {
            display: none;
        }

        /* Estilos para el año del vehículo */
        .year-validation {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        .year-validation.error {
            color: var(--danger);
        }

        .year-validation.success {
            color: var(--success);
        }

        /* Estilos para detalles del conductor */
        .driver-details-panel {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .driver-details-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .driver-details-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .driver-details-info {
            flex: 1;
        }

        .driver-details-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--text);
        }

        .driver-details-rating {
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .driver-detail-item {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 10px;
        }

        .driver-detail-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .driver-detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .vehicle-photo-container {
            margin-top: 15px;
            text-align: center;
        }

        .vehicle-photo {
            width: 100%;
            max-width: 200px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
            cursor: pointer;
        }

        .vehicle-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Estilos para notificaciones push */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Estilos para el sistema de notificaciones en admin */
        .notification-system {
            margin-top: 20px;
        }

        .notification-form {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .notification-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-bg);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 10px;
        }

        .notification-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .notification-targets {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .notification-target {
            flex: 1;
            padding: 8px 12px;
            background: var(--card-bg);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-target.active {
            background: var(--primary);
            color: white;
        }

        .btn-send-notification {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-send-notification:hover {
            background: #3a5bef;
        }

        /* Estilos para la lista negra */
        .blacklist-section {
            margin-top: 20px;
        }

        .blacklist-form {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .blacklist-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .blacklist-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--input-bg);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
        }

        .blacklist-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-add-blacklist {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .blacklist-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .blacklist-item {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .blacklist-plate {
            font-weight: 600;
            color: var(--text);
        }

        .blacklist-reason {
            color: var(--gray);
            font-size: 14px;
        }

        .btn-remove-blacklist {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Estilos para el botón de ver detalles completos */
        .btn-view-details {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        /* Estilos para el panel de detalles completos del conductor */
        .driver-full-details {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .driver-full-details h3 {
            margin-bottom: 15px;
            color: var(--text);
            border-bottom: 1px solid var(--input-bg);
            padding-bottom: 10px;
        }

        .driver-documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .document-item {
            text-align: center;
        }

        .document-preview {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .document-label {
            font-size: 12px;
            color: var(--gray);
        }

        /* Nuevos estilos para mejoras de UI */
        .searching-passengers {
            text-align: center;
            padding: 30px 20px;
            background: var(--input-bg);
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .searching-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .searching-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .searching-dots {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .searching-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: searching 1.4s infinite ease-in-out both;
        }

        .searching-dot:nth-child(1) { animation-delay: -0.32s; }
        .searching-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes searching {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ride-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .arrival-countdown {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .countdown-title {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .countdown-timer {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .countdown-actions {
            display: flex;
            gap: 10px;
        }

        .btn-delayed {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }

        .btn-cancel-ride {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }

        .ride-completed {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .completed-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .completed-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .completed-actions {
            margin-top: 15px;
        }

        .btn-new-ride {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="logo-container">
            <div class="logo-car">
                <div class="car-body"></div>
                <div class="car-top"></div>
                <div class="car-wheel front"></div>
                <div class="car-wheel back"></div>
            </div>
            <div class="logo-text">Two<span>go</span></div>
        </div>
        <div class="preloader-message" id="preloader-message">Nueva manera de moverte</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
    
    <!-- Permission Request -->
    <div class="permission-request" id="permission-request" style="display: none;">
        <div class="permission-card">
            <div class="permission-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="permission-title">Permiso de Ubicación</div>
            <div class="permission-text">
                Para una mejor experiencia, Twogo necesita acceso a tu ubicación para mostrarte conductores cercanos y calcular rutas precisas.
            </div>
            <div class="permission-buttons">
                <button class="btn-permission deny" id="deny-permission">Usar ubicación aproximada</button>
                <button class="btn-permission allow" id="allow-permission">Permitir ubicación precisa</button>
            </div>
        </div>
    </div>
    
    <!-- Auth Container -->
    <div class="auth-container" id="auth-container">
        <div class="auth-logo">
            <div class="logo-car">
                <div class="car-body"></div>
                <div class="car-top"></div>
                <div class="car-wheel front"></div>
                <div class="car-wheel back"></div>
            </div>
            <div class="logo-text">Two<span>go</span></div>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">Iniciar Sesión</div>
            <div class="auth-tab" data-tab="register">Registrarse</div>
        </div>
        
        <!-- Login Form -->
        <div class="auth-form" id="login-form">
            <div class="form-group">
                <label class="form-label" for="login-email">Correo electrónico</label>
                <input type="email" id="login-email" class="form-input" placeholder="tu@email.com">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="login-password">Contraseña</label>
                <input type="password" id="login-password" class="form-input" placeholder="Tu contraseña">
            </div>
            
            <div class="error-message" id="login-error"></div>
            <div class="success-message" id="login-success"></div>
            
            <button class="btn-auth btn-primary" id="btn-login">
                <i class="fas fa-sign-in-alt"></i>
                Iniciar Sesión
            </button>
            
            <div class="divider">
                <span>o continuar con</span>
            </div>
            
            <button class="btn-auth btn-google" id="btn-google-login">
                <i class="fab fa-google"></i>
                Google
            </button>
            
            <div class="auth-footer">
                ¿No tienes cuenta? <a href="#" class="auth-link" id="go-to-register">Regístrate</a>
            </div>
        </div>
        
        <!-- Register Form -->
        <div class="auth-form" id="register-form" style="display: none;">
            <div class="profile-picture-container">
                <div class="profile-picture" id="profile-picture">
                    <i class="fas fa-user"></i>
                    <div class="change-photo">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="photo-upload" accept="image/*" style="display: none;">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="register-name">Nombre completo</label>
                <input type="text" id="register-name" class="form-input" placeholder="Tu nombre completo">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="register-email">Correo electrónico</label>
                <input type="email" id="register-email" class="form-input" placeholder="tu@email.com">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="register-phone">Teléfono</label>
                <div class="phone-input-container">
                    <div class="country-code">+57</div>
                    <input type="tel" id="register-phone" class="form-input phone-input" placeholder="300 123 4567">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="register-password">Contraseña</label>
                <input type="password" id="register-password" class="form-input" placeholder="Crea una contraseña segura">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="register-confirm-password">Confirmar contraseña</label>
                <input type="password" id="register-confirm-password" class="form-input" placeholder="Repite tu contraseña">
            </div>
            
            <div class="error-message" id="register-error"></div>
            <div class="success-message" id="register-success"></div>
            
            <button class="btn-auth btn-primary" id="btn-register">
                <i class="fas fa-user-plus"></i>
                Crear Cuenta
            </button>
            
            <div class="divider">
                <span>o registrarse con</span>
            </div>
            
            <button class="btn-auth btn-google" id="btn-google-register">
                <i class="fab fa-google"></i>
                Google
            </button>
            
            <div class="auth-footer">
                ¿Ya tienes cuenta? <a href="#" class="auth-link" id="go-to-login">Inicia Sesión</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app-container" style="display: none;">
        <div class="header">
            <div class="logo">Twogo Cartagena</div>
            <div class="user-avatar" id="user-avatar">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <button class="theme-toggle" id="theme-toggle" title="Cambiar tema">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            
            <div class="api-status" id="api-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Conectando a Google Maps...</span>
            </div>
            
            <div class="route-info" id="route-info">
                <div class="route-duration">
                    <i class="far fa-clock"></i>
                    <span id="duration">-- min</span>
                </div>
                <div class="route-distance">
                    <i class="fas fa-road"></i>
                    <span id="distance">-- km</span>
                </div>
            </div>
            
            <div class="map-controls">
                <button class="map-btn" id="zoom-in">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-btn" id="zoom-out">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            
            <button class="current-location-btn" id="current-location">
                <i class="fas fa-location-arrow"></i>
            </button>

            <button class="manual-marker-btn" id="manual-marker" title="Colocar marcadores manualmente">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
        
        <div class="bottom-sheet" id="bottom-sheet">
            <div class="drag-handle" id="drag-handle"></div>
            
            <div class="compact-header">
                <div class="compact-title">Solicitar Viaje</div>
                <button class="expand-btn" id="expand-btn">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="mode-selector">
                <div class="mode-btn active" data-mode="passenger">Pasajero</div>
                <div class="mode-btn" data-mode="driver">Conductor</div>
            </div>
            
            <!-- PANEL DE PASAJERO -->
            <div class="passenger-panel" id="passenger-panel">
                <div class="error-panel" id="map-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Error de conexión con el mapa</div>
                    <button class="retry-btn" id="retry-map">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
                
                <!-- Mensaje de ubicación aproximada -->
                <div class="location-fallback" id="location-fallback">
                    <div class="location-fallback-title">
                        <i class="fas fa-info-circle"></i>
                        Usando ubicación aproximada
                    </div>
                    <div class="location-fallback-text">
                        No pudimos obtener tu ubicación precisa. Estamos usando una ubicación de referencia en Cartagena. Puedes establecer manualmente tu ubicación usando el botón de marcadores en el mapa.
                    </div>
                    <button class="location-retry-btn" id="location-retry">
                        <i class="fas fa-sync-alt"></i> Reintentar ubicación
                    </button>
                </div>
                
                <div class="ride-request-form" id="request-form">
                    <div class="location-input" id="pickup-container">
                        <div class="location-icon pickup-icon">
                            <i class="fas fa-circle"></i>
                        </div>
                        <input type="text" id="pickup" placeholder="¿Dónde te recogemos?" value="Mi ubicación actual" autocomplete="off">
                    </div>
                    <div class="location-input" id="destination-container">
                        <div class="location-icon destination-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <input type="text" id="destination" placeholder="¿A dónde vas?" autocomplete="off">
                    </div>
                    
                    <div class="location-loading" id="location-loading">
                        <i class="fas fa-spinner fa-spin"></i> Buscando ubicación precisa...
                    </div>
                    
                    <div class="manual-marker-info" id="manual-marker-info" style="display: none;">
                        <div class="manual-marker-title">Marcadores Manuales</div>
                        <div class="manual-marker-details">
                            <div><strong>Origen:</strong> <span id="manual-pickup-address">No establecido</span></div>
                            <div><strong>Destino:</strong> <span id="manual-destination-address">No establecido</span></div>
                        </div>
                    </div>
                    
                    <div class="price-slider-container">
                        <div class="price-header">
                            <div>Tu precio sugerido</div>
                            <div class="price-value">$<span id="price-display">8.000</span> COP</div>
                        </div>
                        <input type="range" min="5000" max="30000" value="8000" step="1000" class="price-slider" id="price-slider">
                    </div>
                    
                    <button class="btn-request" id="request-btn">
                        <i class="fas fa-car"></i>
                        Solicitar Viaje
                    </button>
                </div>
                
                <div class="loading" id="searching-loading">
                    <div class="spinner"></div>
                    <p>Buscando conductores disponibles...</p>
                </div>
                
                <div class="offers-panel" id="offers-panel">
                    <div class="offers-title">Ofertas de conductores</div>
                    <!-- Las ofertas se cargarán dinámicamente -->
                </div>
                
                <div class="ride-in-progress" id="ride-in-progress">
                    <div class="driver-arrival">Tu conductor está en camino</div>
                    <div class="driver-eta" id="driver-eta">5 min</div>
                    <div>Llegará a: <span id="pickup-location">Mi ubicación actual</span></div>
                    
                    <!-- Panel de detalles del conductor -->
                    <div class="driver-details-panel" id="driver-details-panel" style="display: none;">
                        <div class="driver-details-header">
                            <div class="driver-details-avatar" id="driver-details-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="driver-details-info">
                                <div class="driver-details-name" id="driver-details-name">Nombre del Conductor</div>
                                <div class="driver-details-rating" id="driver-details-rating">
                                    <i class="fas fa-star"></i> 4.8 (120 viajes)
                                </div>
                            </div>
                        </div>
                        
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <div class="driver-detail-label">Vehículo</div>
                                <div class="driver-detail-value" id="driver-details-vehicle">Marca - Modelo</div>
                            </div>
                            <div class="driver-detail-item">
                                <div class="driver-detail-label">Placa</div>
                                <div class="driver-detail-value" id="driver-details-plate">ABC123</div>
                            </div>
                            <div class="driver-detail-item">
                                <div class="driver-detail-label">Color</div>
                                <div class="driver-detail-value" id="driver-details-color">Negro</div>
                            </div>
                            <div class="driver-detail-item">
                                <div class="driver-detail-label">Año</div>
                                <div class="driver-detail-value" id="driver-details-year">2022</div>
                            </div>
                        </div>
                        
                        <div class="vehicle-photo-container">
                            <div class="vehicle-photo" id="driver-details-vehicle-photo">
                                <i class="fas fa-car" style="font-size: 48px; color: var(--gray);"></i>
                            </div>
                            <div class="vehicle-photo-label">Vehículo del conductor</div>
                        </div>
                    </div>
                    
                    <div class="arrival-countdown" id="arrival-countdown">
                        <div class="countdown-title">Conductor ha llegado</div>
                        <div class="countdown-timer" id="countdown-timer">5:00</div>
                        <div class="countdown-actions">
                            <button class="btn-delayed" id="btn-delayed">
                                <i class="fas fa-clock"></i> Muy demorado
                            </button>
                            <button class="btn-cancel-ride" id="btn-cancel-ride">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                    
                    <div class="ride-controls">
                        <button class="btn-action" id="start-ride-passenger" style="display: none;">
                            <i class="fas fa-play"></i> Iniciar Viaje
                        </button>
                        <button class="btn-action" id="complete-ride-passenger" style="display: none;">
                            <i class="fas fa-flag-checkered"></i> Finalizar Viaje
                        </button>
                    </div>
                    
                    <div class="driver-contact">
                        <button class="contact-btn">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="contact-btn">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                </div>
                
                <div class="ride-completed" id="ride-completed">
                    <div class="completed-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="completed-title">¡Viaje Completado!</div>
                    <div>Gracias por usar Twogo</div>
                    <div class="completed-actions">
                        <button class="btn-new-ride" id="btn-new-ride">
                            <i class="fas fa-car"></i> Solicitar Nuevo Viaje
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- PANEL DE CONDUCTOR -->
            <div class="driver-panel" id="driver-panel">
                <!-- Panel para conductores verificados -->
                <div class="driver-status" id="verified-driver-panel" style="display: none;">
                    <div>
                        <div class="driver-name">Modo Conductor</div>
                        <div class="driver-rating">Estado: <span id="driver-status-text">Desconectado</span></div>
                    </div>
                    <div class="status-toggle" id="status-toggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <!-- Panel para conductores no verificados -->
                <div class="driver-mode-disabled" id="unverified-driver-panel">
                    <div class="disabled-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="disabled-title">Verificación Requerida</div>
                    <div class="disabled-description">
                        Para activar el modo conductor, primero debes completar el proceso de verificación. Esto nos ayuda a garantizar la seguridad de todos los usuarios.
                    </div>
                    <button class="btn-apply-verification" id="btn-apply-verification">
                        <i class="fas fa-id-card"></i>
                        Iniciar Verificación
                    </button>
                </div>
                
                <div class="searching-passengers" id="searching-passengers">
                    <div class="searching-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="searching-title">Buscando pasajeros</div>
                    <div class="searching-dots">
                        <div class="searching-dot"></div>
                        <div class="searching-dot"></div>
                        <div class="searching-dot"></div>
                    </div>
                </div>
                
                <div class="ride-request" id="ride-request">
                    <div class="request-details">
                        <div class="request-price" id="request-price">$8.000 COP</div>
                        <div class="request-locations" id="request-locations">De: Ubicación A - A: Ubicación B</div>
                        <div class="manual-marker-details" id="driver-route-details" style="display: none;">
                            <div><strong>Origen:</strong> <span id="driver-pickup-address">No establecido</span></div>
                            <div><strong>Destino:</strong> <span id="driver-destination-address">No establecido</span></div>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="btn-accept-request" id="accept-request">Aceptar</button>
                        <button class="btn-reject-request" id="reject-request">Rechazar</button>
                    </div>
                </div>
                
                <div class="active-ride" id="active-ride">
                    <div class="passenger-info">
                        <div class="passenger-avatar">PM</div>
                        <div>
                            <div class="passenger-name">Pedro Martínez</div>
                            <div class="driver-rating">★ 4.8</div>
                        </div>
                    </div>
                    <div class="request-locations" id="active-ride-locations">De: Ubicación A - A: Ubicación B</div>
                    <div class="ride-actions">
                        <button class="btn-action" id="arrived-btn">
                            <i class="fas fa-check"></i> Ya Llegué
                        </button>
                        <button class="btn-action" id="start-ride">
                            <i class="fas fa-play"></i> Iniciar Viaje
                        </button>
                        <button class="btn-action" id="complete-ride">
                            <i class="fas fa-flag-checkered"></i> Finalizar
                        </button>
                    </div>
                    <button class="google-maps-btn" id="open-google-maps">
                        <i class="fab fa-google"></i> Abrir en Google Maps
                    </button>
                </div>
                
                <div class="ride-completed" id="driver-ride-completed">
                    <div class="completed-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="completed-title">¡Viaje Completado!</div>
                    <div>Puedes recibir nuevas solicitudes</div>
                    <div class="completed-actions">
                        <button class="btn-new-ride" id="btn-new-ride-driver">
                            <i class="fas fa-car"></i> Volver a Buscar
                        </button>
                    </div>
                </div>
                
                <div class="driver-stats hidden" id="driver-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="today-earnings">$0 COP</div>
                            <div class="stat-label">Ganancias Hoy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="completed-rides">0</div>
                            <div class="stat-label">Viajes Completados</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="menu-bar">
            <div class="menu-item active" data-tab="travel">
                <div class="menu-icon">
                    <i class="fas fa-car"></i>
                </div>
                <div>Viajar</div>
            </div>
            <div class="menu-item" data-tab="history">
                <div class="menu-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div>Historial</div>
            </div>
            <div class="menu-item" data-tab="promos">
                <div class="menu-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div>Promociones</div>
            </div>
            <div class="menu-item" data-tab="profile">
                <div class="menu-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div>Perfil</div>
            </div>
            <div class="menu-item admin" data-tab="admin" id="admin-menu-item" style="display: none;">
                <div class="menu-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div>Admin</div>
            </div>
        </div>
    </div>

    <!-- Verification Form - CORREGIDO Y SIMPLIFICADO -->
    <div class="verification-container" id="verification-container">
        <div class="verification-header">
            <div class="verification-title">Verificación de Conductor</div>
            <button class="verification-back-btn" id="verification-back-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        
        <div class="verification-content">
            <div class="verification-section">
                <!-- Información Personal Simplificada -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-id-card"></i>
                        Información Personal
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="driver-full-name">Nombre Completo y Apellido</label>
                        <input type="text" id="driver-full-name" class="form-input" placeholder="Tu nombre completo y apellido">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="driver-id-number">Número de Cédula</label>
                        <input type="text" id="driver-id-number" class="form-input" placeholder="Tu número de cédula">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="driver-birth-date">Fecha de Nacimiento</label>
                        <input type="date" id="driver-birth-date" class="form-input">
                    </div>
                </div>
                
                <!-- Información del Vehículo Simplificada -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-car"></i>
                        Información del Vehículo
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="vehicle-brand">Marca del Vehículo</label>
                        <input type="text" id="vehicle-brand" class="form-input" placeholder="Marca de tu vehículo">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="vehicle-year">Año del Vehículo</label>
                        <input type="number" id="vehicle-year" class="form-input" placeholder="Año de tu vehículo" min="2000" max="2024">
                        <div class="year-validation" id="year-validation">Solo se permiten vehículos desde el año 2000</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="vehicle-color">Color del Vehículo</label>
                        <input type="text" id="vehicle-color" class="form-input" placeholder="Color de tu vehículo">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="vehicle-plate">Placa del Vehículo</label>
                        <input type="text" id="vehicle-plate" class="form-input" placeholder="Placa de tu vehículo" style="text-transform: uppercase;">
                    </div>
                </div>
                
                <!-- Foto de Perfil Simplificada -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-camera"></i>
                        Foto de Perfil
                    </div>
                    <div class="step-description">
                        Toma una foto clara de tu rostro para tu perfil de conductor.
                    </div>
                    
                    <div class="photo-upload-container">
                        <div class="photo-upload-item">
                            <div class="photo-upload-preview" id="profile-photo-preview">
                                <div class="photo-upload-placeholder">
                                    <i class="fas fa-user"></i>
                                    <div>Foto de Perfil</div>
                                </div>
                            </div>
                            <div class="photo-upload-buttons">
                                <button class="btn-capture" id="capture-profile-photo">
                                    <i class="fas fa-camera"></i> Tomar Foto
                                </button>
                            </div>
                            <input type="file" id="profile-photo-input" class="hidden-file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <!-- Documentos del Vehículo Simplificados -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-car"></i>
                        Documentos del Vehículo
                    </div>
                    <div class="step-description">
                        Sube fotos claras de los documentos de tu vehículo.
                    </div>
                    
                    <div class="photo-upload-container">
                        <div class="photo-upload-item">
                            <div class="photo-upload-preview" id="soat-preview">
                                <div class="photo-upload-placeholder">
                                    <i class="fas fa-file-medical"></i>
                                    <div>SOAT</div>
                                </div>
                            </div>
                            <div class="photo-upload-buttons">
                                <button class="btn-upload" id="upload-soat">
                                    <i class="fas fa-upload"></i> Subir Foto
                                </button>
                            </div>
                            <input type="file" id="soat-input" class="hidden-file-input" accept="image/*">
                        </div>
                        
                        <div class="photo-upload-item">
                            <div class="photo-upload-preview" id="tecno-preview">
                                <div class="photo-upload-placeholder">
                                    <i class="fas fa-file-alt"></i>
                                    <div>Tecnomecánica</div>
                                </div>
                            </div>
                            <div class="photo-upload-buttons">
                                <button class="btn-upload" id="upload-tecno">
                                    <i class="fas fa-upload"></i> Subir Foto
                                </button>
                            </div>
                            <input type="file" id="tecno-input" class="hidden-file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <!-- Foto del Vehículo -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-car"></i>
                        Foto del Vehículo
                    </div>
                    <div class="step-description">
                        Sube una foto clara de tu vehículo.
                    </div>
                    
                    <div class="photo-upload-container">
                        <div class="photo-upload-item">
                            <div class="photo-upload-preview" id="vehicle-photo-preview">
                                <div class="photo-upload-placeholder">
                                    <i class="fas fa-car"></i>
                                    <div>Foto del Vehículo</div>
                                </div>
                            </div>
                            <div class="photo-upload-buttons">
                                <button class="btn-upload" id="upload-vehicle-photo">
                                    <i class="fas fa-upload"></i> Subir Foto
                                </button>
                            </div>
                            <input type="file" id="vehicle-photo-input" class="hidden-file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <!-- Términos y Condiciones -->
                <div class="verification-step">
                    <div class="step-title">
                        <i class="fas fa-shield-alt"></i>
                        Términos y Condiciones
                    </div>
                    <div class="step-description">
                        Lee y acepta nuestros términos y condiciones para continuar.
                    </div>
                    
                    <div class="terms-container">
                        <div class="terms-title">Política de Privacidad y Términos de Servicio</div>
                        <div class="terms-text">
                            <p>Al enviar tu solicitud de verificación como conductor en Twogo, aceptas los siguientes términos:</p>
                            <ol>
                                <li>Tus datos personales serán utilizados exclusivamente para fines de verificación y operación del servicio.</li>
                                <li>Twogo se compromete a proteger tu información personal y no la compartirá con terceros sin tu consentimiento explícito.</li>
                                <li>Las imágenes de tus documentos serán almacenadas de forma segura y utilizadas únicamente para verificación interna.</li>
                                <li>Te comprometes a proporcionar información veraz y actualizada.</li>
                                <li>Aceptas cumplir con todas las normas de tránsito y regulaciones locales durante la prestación del servicio.</li>
                                <li>Twogo se reserva el derecho de rechazar solicitudes que no cumplan con los requisitos establecidos.</li>
                                <li>Puedes solicitar la eliminación de tus datos en cualquier momento contactando a nuestro equipo de soporte.</li>
                            </ol>
                            <p>Para más información sobre nuestro manejo de datos, consulta nuestra <a href="#">Política de Privacidad completa</a>.</p>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="accept-terms">
                        <label class="checkbox-label" for="accept-terms">
                            He leído y acepto los <a href="#">términos y condiciones</a> y la <a href="#">política de privacidad</a> de Twogo. Entiendo que mis datos serán utilizados exclusivamente para fines de verificación y no serán compartidos con terceros.
                        </label>
                    </div>
                </div>
                
                <div class="verification-submit">
                    <button class="btn-submit-verification" id="btn-submit-verification" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Enviar Solicitud de Verificación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <button class="image-modal-close" id="image-modal-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="image-modal-content">
            <img id="modal-image" src="" alt="Imagen ampliada">
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header">
            <div class="admin-title">Panel de Administración - Twogo Cartagena</div>
            <button class="admin-back-btn" id="admin-back-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        
        <div class="admin-content">
            <div class="admin-section">
                <div class="section-title">
                    <i class="fas fa-user-clock"></i>
                    Solicitudes de Conductores Pendientes
                </div>
                
                <div class="pending-drivers-list" id="pending-drivers-list">
                    <!-- Las solicitudes se cargarán dinámicamente -->
                </div>
            </div>
            
            <div class="admin-section">
                <div class="section-title">
                    <i class="fas fa-user-check"></i>
                    Conductores Verificados
                </div>
                
                <div class="verified-drivers-list" id="verified-drivers-list">
                    <!-- Los conductores verificados se cargarán dinámicamente -->
                </div>
            </div>
            
            <div class="admin-section">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Estadísticas de la Plataforma
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Usuarios Totales</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="active-drivers">0</div>
                        <div class="stat-label">Conductores Activos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="today-rides"></div>
                        <div class="stat-label">Viajes Hoy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-earnings"></div>
                        <div class="stat-label">Ganancias Totales</div>
                    </div>
                </div>
            </div>
            
            <!-- Sistema de Notificaciones -->
            <div class="admin-section">
                <div class="section-title">
                    <i class="fas fa-bell"></i>
                    Sistema de Notificaciones
                </div>
                
                <div class="notification-system">
                    <div class="notification-form">
                        <textarea id="notification-message" placeholder="Escribe tu mensaje de notificación aquí..."></textarea>
                        
                        <div class="notification-targets">
                            <div class="notification-target active" data-target="all">Todos los Usuarios</div>
                            <div class="notification-target" data-target="passengers">Solo Pasajeros</div>
                            <div class="notification-target" data-target="drivers">Solo Conductores</div>
                        </div>
                        
                        <button class="btn-send-notification" id="btn-send-notification">
                            <i class="fas fa-paper-plane"></i> Enviar Notificación
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Lista Negra de Placas -->
            <div class="admin-section">
                <div class="section-title">
                    <i class="fas fa-ban"></i>
                    Lista Negra de Placas
                </div>
                
                <div class="blacklist-section">
                    <div class="blacklist-form">
                        <div class="blacklist-input-group">
                            <input type="text" id="blacklist-plate" placeholder="Ingresa la placa (ej: ABC123)" style="text-transform: uppercase;">
                            <input type="text" id="blacklist-reason" placeholder="Motivo de la restricción">
                        </div>
                        <button class="btn-add-blacklist" id="btn-add-blacklist">
                            <i class="fas fa-plus"></i> Agregar a Lista Negra
                        </button>
                    </div>
                    
                    <div class="blacklist-items" id="blacklist-items">
                        <!-- Las placas en lista negra se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9DUMhRktbGski6YYA3-SeiAMuWg4ZJN0",
            authDomain: "twogo-76e62.firebaseapp.com",
            databaseURL: "https://twogo-76e62-default-rtdb.firebaseio.com",
            projectId: "twogo-76e62",
            storageBucket: "twogo-76e62.firebasestorage.app",
            messagingSenderId: "83126867601",
            appId: "1:83126867601:web:5f81cd1492dc452de61130",
            measurementId: "G-10VW270YWQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();
        const messaging = firebase.messaging();

        // Variables globales
        let map, directionsService, directionsRenderer, geocoder;
        let userMarker, pickupMarker, destinationMarker, driverMarker;
        let autocompletePickup, autocompleteDestination;
        let userLocation = { lat: 10.3910, lng: -75.4794 }; // Cartagena por defecto
        let pickupLocation = null;
        let destinationLocation = null;
        let drivers = [];
        let currentDriver = null;
        let countdownInterval = null;
        let arrivalCountdownInterval = null;
        let isDriverMode = false;
        let driverStatus = false;
        let currentRideRequest = null;
        let locationWatchId = null;
        let isManualMarkerMode = false;
        let pendingRideRequests = [];
        let isNightMode = false;
        let manualMarkerClickListener = null;
        let userData = null;
        let locationPermissionGranted = false;
        let manualPickupAddress = '';
        let manualDestinationAddress = '';
        let isUsingFallbackLocation = false;
        let locationRequested = false;
        let isAdmin = false;
        let isDriverVerified = false;
        let hasAppliedForVerification = false;
        let activeRide = null;
        let blacklist = [];
        let rideState = 'idle'; // Estados: idle, searching, driver_accepted, driver_arrived, ride_started, ride_completed
        let arrivalCountdown = 300; // 5 minutos en segundos
        
        // Datos de verificación simplificados
        let verificationData = {
            profilePhoto: null,
            soat: null,
            tecnomecanica: null,
            vehiclePhoto: null
        };

        // Función para mostrar notificaciones toast
        function showToast(title, message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            if (type === 'error') icon = 'fas fa-times-circle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Mostrar toast con animación
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Cerrar toast al hacer clic en el botón de cerrar
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                hideToast(toast);
            });
            
            // Auto-ocultar después de la duración especificada
            if (duration > 0) {
                setTimeout(() => {
                    hideToast(toast);
                }, duration);
            }
            
            return toast;
        }
        
        function hideToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 400);
        }

        // Función para verificar y actualizar el estado de administrador
        function checkAndUpdateAdminStatus(user) {
            if (user && user.email === 'thecam35@gmail.com') {
                console.log('✅ Usuario es administrador (email verificado)');
                showAdminPanel();
            } else if (user) {
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            userData = doc.data();
                            isAdmin = userData.isAdmin === true;
                            
                            console.log('🔍 Verificando estado admin:', {
                                'userData.isAdmin': userData.isAdmin,
                                'isAdmin (boolean)': isAdmin,
                                'userEmail': user.email
                            });
                            
                            if (isAdmin || user.email === 'thecam35@gmail.com') {
                                console.log('✅ Usuario es administrador');
                                showAdminPanel();
                            } else {
                                console.log('❌ Usuario NO es administrador');
                                showNormalApp();
                            }
                        } else {
                            // Si no existe el documento, crear uno por defecto
                            const isUserAdmin = user.email === 'thecam35@gmail.com';
                            saveUserToFirestore(user, {
                                isAdmin: isUserAdmin
                            }).then(() => {
                                if (isUserAdmin) {
                                    showAdminPanel();
                                } else {
                                    showNormalApp();
                                }
                            });
                        }
                    })
                    .catch((error) => {
                        console.error('Error obteniendo datos usuario:', error);
                        showNormalApp();
                    });
            }
        }

        // Función para mostrar el panel de administración
        function showAdminPanel() {
            // Ocultar todo
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            
            // Mostrar panel de administración
            document.getElementById('admin-panel').style.display = 'flex';
            
            console.log('🔧 Panel de administración ACTIVADO');
            showToast('Modo Administrador', 'Bienvenido al panel de administración', 'success', 3000);
            
            // Cargar solicitudes pendientes
            loadPendingDriverApplications();
            loadVerifiedDrivers();
            loadBlacklist();
            
            // Configurar sistema de notificaciones
            setupNotificationSystem();
        }

        // Función para mostrar la aplicación normal
        function showNormalApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Verificar si el usuario es conductor verificado
            checkDriverVerificationStatus();
            
            // Inicializar mapa solo para usuarios normales
            if (typeof initMap === 'function') {
                initMap();
            }
        }

        // Verificar estado de verificación del conductor
        function checkDriverVerificationStatus() {
            const user = auth.currentUser;
            if (user) {
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            isDriverVerified = userData.isDriverVerified || false;
                            hasAppliedForVerification = userData.hasAppliedForVerification || false;
                            
                            // Actualizar UI según el estado de verificación
                            updateDriverUI();
                        }
                    })
                    .catch((error) => {
                        console.error('Error verificando estado de conductor:', error);
                    });
            }
        }

        // Actualizar UI del modo conductor según estado de verificación
        function updateDriverUI() {
            if (isDriverVerified) {
                // Mostrar panel de conductor verificado
                document.getElementById('verified-driver-panel').style.display = 'flex';
                document.getElementById('unverified-driver-panel').style.display = 'none';
                document.getElementById('driver-stats').classList.remove('hidden');
            } else {
                // Mostrar panel de verificación requerida
                document.getElementById('verified-driver-panel').style.display = 'none';
                document.getElementById('unverified-driver-panel').style.display = 'block';
                document.getElementById('driver-stats').classList.add('hidden');
                
                // Si ya aplicó pero no está verificado, mostrar estado pendiente
                if (hasAppliedForVerification) {
                    document.querySelector('.disabled-title').textContent = 'Verificación en Proceso';
                    document.querySelector('.disabled-description').textContent = 'Tu solicitud de verificación está siendo revisada. Te notificaremos una vez sea aprobada.';
                    document.getElementById('btn-apply-verification').style.display = 'none';
                }
            }
        }

        // Cargar solicitudes de conductores pendientes
        function loadPendingDriverApplications() {
            const pendingList = document.getElementById('pending-drivers-list');
            pendingList.innerHTML = '<div class="no-applications"><i class="fas fa-spinner fa-spin"></i><div>Cargando solicitudes...</div></div>';
            
            db.collection('driverApplications').where('status', '==', 'pending').get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        pendingList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-user-check"></i>
                                <div>No hay solicitudes pendientes</div>
                            </div>
                        `;
                        return;
                    }
                    
                    pendingList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const application = doc.data();
                        const applicationElement = createDriverApplicationElement(doc.id, application);
                        pendingList.appendChild(applicationElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando solicitudes:', error);
                    pendingList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando solicitudes: ${error.message}</div>
                        </div>
                    `;
                });
        }

        // Cargar conductores verificados
        function loadVerifiedDrivers() {
            const verifiedList = document.getElementById('verified-drivers-list');
            verifiedList.innerHTML = '<div class="no-applications"><i class="fas fa-spinner fa-spin"></i><div>Cargando conductores...</div></div>';
            
            db.collection('users').where('isDriverVerified', '==', true).get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        verifiedList.innerHTML = `
                            <div class="no-applications">
                                <i class="fas fa-user-check"></i>
                                <div>No hay conductores verificados</div>
                            </div>
                        `;
                        return;
                    }
                    
                    verifiedList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const driver = doc.data();
                        const driverElement = createVerifiedDriverElement(doc.id, driver);
                        verifiedList.appendChild(driverElement);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando conductores verificados:', error);
                    verifiedList.innerHTML = `
                        <div class="no-applications">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Error cargando conductores: ${error.message}</div>
                        </div>
                    `;
                });
        }

        // Crear elemento de solicitud de conductor para el panel de administración
        function createDriverApplicationElement(id, application) {
            const element = document.createElement('div');
            element.className = 'driver-application';
            element.innerHTML = `
                <div class="driver-app-info">
                    <div class="driver-app-avatar">
                        ${application.profilePhoto ? 
                            `<img src="${application.profilePhoto}" alt="${application.fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                            (application.fullName ? application.fullName.charAt(0).toUpperCase() : 'U')
                        }
                    </div>
                    <div class="driver-app-details">
                        <div class="driver-app-name">${application.fullName || 'Nombre no disponible'}</div>
                        <div class="driver-app-phone">${application.phone || 'Teléfono no disponible'}</div>
                        <div class="driver-app-email">${application.email || 'Email no disponible'}</div>
                        <div class="driver-app-plate">Placa: ${application.vehiclePlate || 'No disponible'}</div>
                    </div>
                </div>
                <div class="driver-app-actions">
                    <button class="btn-approve" data-id="${id}">
                        <i class="fas fa-check"></i> Aprobar
                    </button>
                    <button class="btn-reject" data-id="${id}">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                    <button class="btn-view-details" data-id="${id}">
                        <i class="fas fa-eye"></i> Ver Detalles
                    </button>
                </div>
            `;
            
            // Agregar event listeners
            element.querySelector('.btn-approve').addEventListener('click', () => approveDriverApplication(id, application));
            element.querySelector('.btn-reject').addEventListener('click', () => rejectDriverApplication(id));
            element.querySelector('.btn-view-details').addEventListener('click', () => viewDriverFullDetails(application));
            
            return element;
        }

        // Crear elemento de conductor verificado para el panel de administración
        function createVerifiedDriverElement(id, driver) {
            const element = document.createElement('div');
            element.className = 'verified-driver-card';
            element.innerHTML = `
                <div class="verified-driver-avatar">
                    ${driver.photoURL ? 
                        `<img src="${driver.photoURL}" alt="${driver.displayName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                        (driver.displayName ? driver.displayName.charAt(0).toUpperCase() : 'U')
                    }
                </div>
                <div class="verified-driver-name">${driver.displayName || 'Nombre no disponible'}</div>
                <div class="verified-driver-phone">${driver.phoneNumber || 'Teléfono no disponible'}</div>
                <div class="verified-driver-plate">${driver.vehiclePlate || 'Placa no disponible'}</div>
                <div class="verified-driver-status">
                    <i class="fas fa-check-circle"></i> Verificado
                </div>
                <button class="btn-revoke" data-id="${id}">
                    <i class="fas fa-user-slash"></i> Revocar Verificación
                </button>
                <button class="btn-view-details" data-id="${id}" style="margin-top: 5px;">
                    <i class="fas fa-eye"></i> Ver Detalles
                </button>
            `;
            
            // Agregar event listener
            element.querySelector('.btn-revoke').addEventListener('click', () => revokeDriverVerification(id, driver));
            element.querySelector('.btn-view-details').addEventListener('click', () => {
                // Obtener datos completos de la aplicación
                db.collection('driverApplications').where('userId', '==', id).get()
                    .then((querySnapshot) => {
                        if (!querySnapshot.empty) {
                            const application = querySnapshot.docs[0].data();
                            viewDriverFullDetails(application);
                        } else {
                            showToast('Error', 'No se encontraron los detalles completos del conductor', 'error');
                        }
                    });
            });
            
            return element;
        }

        // Aprobar solicitud de conductor
        function approveDriverApplication(applicationId, application) {
            // Verificar si la placa está en lista negra
            if (application.vehiclePlate && isPlateBlacklisted(application.vehiclePlate)) {
                showToast('Error', `La placa ${application.vehiclePlate} está en lista negra y no puede ser aprobada`, 'error');
                return;
            }
            
            // Actualizar estado de la solicitud
            db.collection('driverApplications').doc(applicationId).update({
                status: 'approved',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewedBy: auth.currentUser.uid
            })
            .then(() => {
                // Actualizar usuario como conductor verificado
                return db.collection('users').doc(application.userId).update({
                    isDriverVerified: true,
                    hasAppliedForVerification: true,
                    driverVerifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    vehiclePlate: application.vehiclePlate,
                    vehicleBrand: application.vehicleBrand,
                    vehicleYear: application.vehicleYear,
                    vehicleColor: application.vehicleColor
                });
            })
            .then(() => {
                showToast('Solicitud Aprobada', `${application.fullName} ha sido aprobado como conductor`, 'success');
                
                // Enviar notificación push al conductor
                sendPushNotification(
                    application.userId,
                    '¡Felicidades! Tu solicitud ha sido aprobada',
                    'Ya eres un conductor verificado en Twogo. Puedes comenzar a recibir solicitudes de viaje.'
                );
                
                // Recargar listas
                loadPendingDriverApplications();
                loadVerifiedDrivers();
            })
            .catch((error) => {
                console.error('Error aprobando solicitud:', error);
                showToast('Error', 'No se pudo aprobar la solicitud: ' + error.message, 'error');
            });
        }

        // Rechazar solicitud de conductor
        function rejectDriverApplication(applicationId) {
            db.collection('driverApplications').doc(applicationId).update({
                status: 'rejected',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewedBy: auth.currentUser.uid
            })
            .then(() => {
                showToast('Solicitud Rechazada', 'La solicitud ha sido rechazada', 'warning');
                loadPendingDriverApplications();
            })
            .catch((error) => {
                console.error('Error rechazando solicitud:', error);
                showToast('Error', 'No se pudo rechazar la solicitud: ' + error.message, 'error');
            });
        }

        // Revocar verificación de conductor
        function revokeDriverVerification(userId, driver) {
            // Agregar placa a lista negra
            if (driver.vehiclePlate) {
                addToBlacklist(driver.vehiclePlate, 'Verificación revocada por administrador');
            }
            
            db.collection('users').doc(userId).update({
                isDriverVerified: false
            })
            .then(() => {
                showToast('Verificación Revocada', 'El conductor ya no está verificado', 'info');
                loadVerifiedDrivers();
            })
            .catch((error) => {
                console.error('Error revocando verificación:', error);
                showToast('Error', 'No se pudo revocar la verificación: ' + error.message, 'error');
            });
        }

        // Ver documentos del conductor
        function viewDriverDocuments(application) {
            // Crear modal para ver documentos
            const modal = document.createElement('div');
            modal.className = 'image-modal active';
            modal.style.zIndex = '10004';
            
            let documentsHTML = '';
            
            // Agregar cada documento si existe
            if (application.profilePhoto) {
                documentsHTML += `
                    <div class="document-item">
                        <h3>Foto de Perfil</h3>
                        <img src="${application.profilePhoto}" alt="Foto de perfil" class="document-image" data-src="${application.profilePhoto}" style="width: 100%; max-height: 300px; object-fit: contain; cursor: pointer;">
                    </div>
                `;
            }
            
            if (application.soat) {
                documentsHTML += `
                    <div class="document-item">
                        <h3>SOAT</h3>
                        <img src="${application.soat}" alt="SOAT" class="document-image" data-src="${application.soat}" style="width: 100%; max-height: 300px; object-fit: contain; cursor: pointer;">
                    </div>
                `;
            }
            
            if (application.tecnomecanica) {
                documentsHTML += `
                    <div class="document-item">
                        <h3>Tecnomecánica</h3>
                        <img src="${application.tecnomecanica}" alt="Tecnomecánica" class="document-image" data-src="${application.tecnomecanica}" style="width: 100%; max-height: 300px; object-fit: contain; cursor: pointer;">
                    </div>
                `;
            }
            
            if (application.vehiclePhoto) {
                documentsHTML += `
                    <div class="document-item">
                        <h3>Foto del Vehículo</h3>
                        <img src="${application.vehiclePhoto}" alt="Foto del vehículo" class="document-image" data-src="${application.vehiclePhoto}" style="width: 100%; max-height: 300px; object-fit: contain; cursor: pointer;">
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <button class="image-modal-close" id="documents-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="documents-container" style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #333;">Documentos de ${application.fullName}</h2>
                    <div class="documents-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        ${documentsHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Agregar event listener para cerrar modal
            modal.querySelector('#documents-modal-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Agregar event listeners para ampliar imágenes
            modal.querySelectorAll('.document-image').forEach(img => {
                img.addEventListener('click', () => {
                    openImageModal(img.getAttribute('data-src'));
                });
            });
        }

        // Ver detalles completos del conductor
        function viewDriverFullDetails(application) {
            // Crear modal para ver detalles completos
            const modal = document.createElement('div');
            modal.className = 'image-modal active';
            modal.style.zIndex = '10004';
            
            let documentsHTML = '';
            
            // Agregar cada documento si existe
            if (application.profilePhoto) {
                documentsHTML += `
                    <div class="document-item">
                        <div class="document-preview">
                            <img src="${application.profilePhoto}" alt="Foto de perfil" class="document-image" data-src="${application.profilePhoto}">
                        </div>
                        <div class="document-label">Foto de Perfil</div>
                    </div>
                `;
            }
            
            if (application.soat) {
                documentsHTML += `
                    <div class="document-item">
                        <div class="document-preview">
                            <img src="${application.soat}" alt="SOAT" class="document-image" data-src="${application.soat}">
                        </div>
                        <div class="document-label">SOAT</div>
                    </div>
                `;
            }
            
            if (application.tecnomecanica) {
                documentsHTML += `
                    <div class="document-item">
                        <div class="document-preview">
                            <img src="${application.tecnomecanica}" alt="Tecnomecánica" class="document-image" data-src="${application.tecnomecanica}">
                        </div>
                        <div class="document-label">Tecnomecánica</div>
                    </div>
                `;
            }
            
            if (application.vehiclePhoto) {
                documentsHTML += `
                    <div class="document-item">
                        <div class="document-preview">
                            <img src="${application.vehiclePhoto}" alt="Foto del vehículo" class="document-image" data-src="${application.vehiclePhoto}">
                        </div>
                        <div class="document-label">Foto del Vehículo</div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <button class="image-modal-close" id="full-details-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="driver-full-details" style="max-width: 90%; max-height: 90%; overflow-y: auto;">
                    <h3>Detalles Completos de ${application.fullName}</h3>
                    
                    <div class="driver-details-grid">
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Nombre Completo</div>
                            <div class="driver-detail-value">${application.fullName || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Cédula</div>
                            <div class="driver-detail-value">${application.idNumber || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Fecha de Nacimiento</div>
                            <div class="driver-detail-value">${application.birthDate || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Email</div>
                            <div class="driver-detail-value">${application.email || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Teléfono</div>
                            <div class="driver-detail-value">${application.phone || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Marca del Vehículo</div>
                            <div class="driver-detail-value">${application.vehicleBrand || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Año del Vehículo</div>
                            <div class="driver-detail-value">${application.vehicleYear || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Color del Vehículo</div>
                            <div class="driver-detail-value">${application.vehicleColor || 'No disponible'}</div>
                        </div>
                        <div class="driver-detail-item">
                            <div class="driver-detail-label">Placa del Vehículo</div>
                            <div class="driver-detail-value">${application.vehiclePlate || 'No disponible'}</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Documentos</h3>
                    <div class="driver-documents-grid">
                        ${documentsHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Agregar event listener para cerrar modal
            modal.querySelector('#full-details-modal-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Agregar event listeners para ampliar imágenes
            modal.querySelectorAll('.document-image').forEach(img => {
                img.addEventListener('click', () => {
                    openImageModal(img.getAttribute('data-src'));
                });
            });
        }

        // Inicializar la aplicación
        function initMap() {
            try {
                // Determinar si es de noche
                isNightMode = isNightTime();
                
                // Inicializar mapa con estilo detallado
                map = new google.maps.Map(document.getElementById('map'), {
                    center: userLocation,
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: true,
                    fullscreenControl: true,
                    clickableIcons: true,
                    gestureHandling: "greedy"
                });
                
                // Inicializar servicios
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: '#4a6bff',
                        strokeWeight: 5,
                        strokeOpacity: 0.7
                    }
                });
                
                // Inicializar geocoder
                geocoder = new google.maps.Geocoder();
                
                // Agregar marcador del usuario
                addUserMarker();
                
                // Configurar autocomplete
                setupAutocomplete();
                
                // Cargar conductores
                addDriversToMap();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Obtener ubicación del usuario
                getUserLocation();
                
                // Aplicar modo nocturno si es necesario
                applyNightMode();
                
                // Actualizar estado de API
                document.getElementById('status-text').textContent = 'Google Maps conectado';
                document.getElementById('status-dot').style.background = '#28a745';
                document.getElementById('map-error').style.display = 'none';
                
                // Simular conductores
                simulateDrivers();
                
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                document.getElementById('status-text').textContent = 'Error inicializando mapa';
                document.getElementById('status-dot').style.background = '#dc3545';
                document.getElementById('map-error').style.display = 'block';
            }
        }

        // Agregar marcador del usuario
        function addUserMarker() {
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: isUsingFallbackLocation ? '#ff6b4a' : '#4a6bff',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                title: isUsingFallbackLocation ? 'Ubicación aproximada' : 'Tu ubicación actual'
            });
        }

        // Agregar conductores al mapa
        function addDriversToMap() {
            drivers.forEach(driver => {
                const driverIcon = {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#4a6bff" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                };
                
                driver.marker = new google.maps.Marker({
                    position: driver.location,
                    map: map,
                    icon: driverIcon,
                    title: `${driver.name} - ★ ${driver.rating}`
                });
                
                // Info window para el conductor
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <b>${driver.name}</b><br>
                            ★ ${driver.rating} (${driver.trips} viajes)
                        </div>
                    `
                });
                
                driver.marker.addListener('click', () => {
                    infoWindow.open(map, driver.marker);
                });
            });
        }

        // Configurar autocomplete
        function setupAutocomplete() {
            // Autocomplete para pickup
            autocompletePickup = new google.maps.places.Autocomplete(
                document.getElementById('pickup'),
                {
                    types: ['geocode'],
                    componentRestrictions: { country: 'co' }
                }
            );
            
            // Autocomplete para destino
            autocompleteDestination = new google.maps.places.Autocomplete(
                document.getElementById('destination'),
                {
                    types: ['geocode'],
                    componentRestrictions: { country: 'co' }
                }
            );
            
            // Listeners para cuando se selecciona un lugar
            autocompletePickup.addListener('place_changed', () => {
                const place = autocompletePickup.getPlace();
                if (place.geometry) {
                    pickupLocation = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    addPickupMarker(pickupLocation);
                    if (destinationLocation) {
                        calculateRoute();
                    }
                }
            });
            
            autocompleteDestination.addListener('place_changed', () => {
                const place = autocompleteDestination.getPlace();
                if (place.geometry) {
                    destinationLocation = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    addDestinationMarker(destinationLocation);
                    if (pickupLocation) {
                        calculateRoute();
                    }
                }
            });
        }

        // Agregar marcador de recogida
        function addPickupMarker(location) {
            if (pickupMarker) {
                pickupMarker.setMap(null);
            }
            
            pickupMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#28a745', // Verde para origen
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                title: 'Punto de recogida'
            });
        }

        // Agregar marcador de destino
        function addDestinationMarker(location) {
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }
            
            destinationMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#dc3545', // Rojo para destino
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                title: 'Destino'
            });
        }

        // Obtener ubicación del usuario
        function getUserLocation() {
            if (locationRequested) return;
            locationRequested = true;
            
            document.getElementById('location-loading').style.display = 'block';
            document.getElementById('status-text').textContent = 'Obteniendo ubicación...';
            document.getElementById('location-fallback').style.display = 'none';

            // Primero verificamos si ya tenemos permisos
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    if (result.state === 'granted') {
                        // Ya tenemos permisos, obtener ubicación directamente
                        getPreciseLocation();
                    } else if (result.state === 'prompt') {
                        // Mostrar solicitud de permisos
                        showLocationPermissionRequest();
                    } else {
                        // Permisos denegados, usar ubicación por defecto
                        useFallbackLocation();
                    }
                });
            } else {
                // Navegador no soporta navigator.permissions, intentar obtener ubicación directamente
                getPreciseLocation();
            }
        }

        // Obtener ubicación precisa
        function getPreciseLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Éxito - ubicación precisa obtenida
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        isUsingFallbackLocation = false;
                        updateUserLocation();
                        document.getElementById('location-loading').style.display = 'none';
                        document.getElementById('status-text').textContent = 'Ubicación precisa obtenida';
                        locationPermissionGranted = true;
                        
                        showToast('Ubicación precisa', 'Tu ubicación se ha detectado correctamente', 'success', 3000);
                        startLocationTracking();
                    },
                    (error) => {
                        // Error - usar ubicación por defecto
                        console.warn('GPS no disponible:', error);
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                // Geolocalización no soportada
                document.getElementById('location-loading').style.display = 'none';
                document.getElementById('status-text').textContent = 'Geolocalización no soportada';
                useFallbackLocation();
            }
        }

        // Usar ubicación de respaldo
        function useFallbackLocation() {
            isUsingFallbackLocation = true;
            document.getElementById('location-loading').style.display = 'none';
            document.getElementById('location-fallback').style.display = 'block';
            
            // Actualizar marcador para mostrar que es ubicación aproximada
            if (userMarker) {
                userMarker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#ff6b4a',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                });
                userMarker.setTitle('Ubicación aproximada');
            }
            
            updateUserLocation();
        }

        // Manejar errores de ubicación
        function handleLocationError(error) {
            document.getElementById('location-loading').style.display = 'none';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById('status-text').textContent = 'Permiso de ubicación denegado';
                    showToast('Ubicación no disponible', 'Permite el acceso a ubicación para una mejor experiencia', 'warning');
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById('status-text').textContent = 'Ubicación no disponible';
                    showToast('Ubicación no disponible', 'No se pudo obtener tu ubicación', 'warning');
                    break;
                case error.TIMEOUT:
                    document.getElementById('status-text').textContent = 'Tiempo de espera agotado';
                    showToast('Tiempo agotado', 'La obtención de ubicación tomó demasiado tiempo', 'warning');
                    break;
                default:
                    document.getElementById('status-text').textContent = 'Error desconocido';
                    showToast('Error de ubicación', 'No se pudo obtener tu ubicación', 'error');
                    break;
            }
            
            useFallbackLocation();
        }

        // Mostrar solicitud de permisos de ubicación
        function showLocationPermissionRequest() {
            const permissionRequest = document.getElementById('permission-request');
            permissionRequest.style.display = 'flex';
            
            document.getElementById('allow-permission').addEventListener('click', function() {
                permissionRequest.style.display = 'none';
                locationPermissionGranted = true;
                getPreciseLocation();
            });
            
            document.getElementById('deny-permission').addEventListener('click', function() {
                permissionRequest.style.display = 'none';
                useFallbackLocation();
                showToast('Ubicación aproximada', 'Puedes usar marcadores manuales para establecer tu ubicación', 'info');
            });
        }

        // Seguimiento continuo de ubicación
        function startLocationTracking() {
            if (navigator.geolocation && locationPermissionGranted) {
                locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Calcular distancia
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(userLocation),
                            new google.maps.LatLng(newLocation)
                        );
                        
                        // Solo actualizar si la ubicación cambió significativamente (más de 10 metros)
                        if (distance > 10) {
                            userLocation = newLocation;
                            isUsingFallbackLocation = false;
                            updateUserLocation();
                            
                            // Ocultar mensaje de ubicación aproximada si se estaba mostrando
                            document.getElementById('location-fallback').style.display = 'none';
                            
                            // Actualizar marcador
                            if (userMarker) {
                                userMarker.setIcon({
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4a6bff',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 2
                                });
                                userMarker.setTitle('Tu ubicación actual');
                            }
                        }
                    },
                    (error) => {
                        console.warn('Error en seguimiento de ubicación:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            }
        }

        // Actualizar ubicación del usuario
        function updateUserLocation() {
            if (userMarker) {
                userMarker.setPosition(userLocation);
            }
            if (map) {
                map.setCenter(userLocation);
                map.setZoom(16);
            }
            
            // Actualizar campo de recogida solo si no estamos en modo manual
            if (!isManualMarkerMode) {
                document.getElementById('pickup').value = isUsingFallbackLocation ? 
                    "Ubicación aproximada (Cartagena)" : "Mi ubicación actual";
                pickupLocation = userLocation;
            }
        }

        // Calcular ruta
        function calculateRoute() {
            if (!pickupLocation || !destinationLocation) return;

            const request = {
                origin: pickupLocation,
                destination: destinationLocation,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    updateRouteInfo(result);
                } else {
                    console.warn('Error calculando ruta:', status);
                    // Fallback: calcular distancia aproximada
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(pickupLocation),
                        new google.maps.LatLng(destinationLocation)
                    ) / 1000; // Convertir a km
                    updatePriceBasedOnDistance(distance);
                }
            });
        }

        // Actualizar información de la ruta
        function updateRouteInfo(result) {
            const route = result.routes[0].legs[0];
            const duration = Math.round(route.duration.value / 60); // Minutos
            const distance = (route.distance.value / 1000).toFixed(1); // Km

            document.getElementById('duration').textContent = `${duration} min`;
            document.getElementById('distance').textContent = `${distance} km`;
            document.getElementById('route-info').style.display = 'block';

            updatePriceBasedOnDistance(distance);
        }

        // Actualizar precio basado en distancia
        function updatePriceBasedOnDistance(distance) {
            const basePrice = 4000;
            const pricePerKm = 1200;
            const calculatedPrice = Math.round(basePrice + (distance * pricePerKm));
            const finalPrice = Math.max(5000, Math.min(30000, calculatedPrice));
            
            document.getElementById('price-slider').value = finalPrice;
            document.getElementById('price-display').textContent = finalPrice.toLocaleString('es-CO');
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Control del slider de precio
            const priceSlider = document.getElementById('price-slider');
            const priceDisplay = document.getElementById('price-display');
            
            priceSlider.addEventListener('input', function() {
                const price = parseInt(this.value).toLocaleString('es-CO');
                priceDisplay.textContent = price;
            });
            
            // Control del panel deslizante
            const bottomSheet = document.getElementById('bottom-sheet');
            const dragHandle = document.getElementById('drag-handle');
            const expandBtn = document.getElementById('expand-btn');
            
            dragHandle.addEventListener('click', toggleBottomSheet);
            expandBtn.addEventListener('click', toggleBottomSheet);
            
            function toggleBottomSheet() {
                bottomSheet.classList.toggle('expanded');
                expandBtn.innerHTML = bottomSheet.classList.contains('expanded') ? 
                    '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-up"></i>';
            }
            
            // Selector de modo
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.getAttribute('data-mode') === 'driver') {
                        switchToDriverMode();
                    } else {
                        switchToPassengerMode();
                    }
                });
            });
            
            // Toggle de estado del conductor
            document.getElementById('status-toggle').addEventListener('click', function() {
                if (!isDriverVerified) {
                    showToast('Verificación requerida', 'Debes ser un conductor verificado para activar el modo conductor', 'warning');
                    return;
                }
                
                driverStatus = !driverStatus;
                this.classList.toggle('active');
                document.getElementById('driver-status-text').textContent = driverStatus ? 'En línea' : 'Desconectado';
                
                if (driverStatus) {
                    showToast('Modo conductor activado', 'Ahora puedes recibir solicitudes de viaje', 'success');
                    document.getElementById('searching-passengers').style.display = 'block';
                    // Enviar solicitudes a conductores cuando se activa el modo
                    if (pendingRideRequests.length > 0) {
                        sendRideRequestsToDrivers();
                    }
                } else {
                    showToast('Modo conductor desactivado', 'Ya no recibirás nuevas solicitudes', 'warning');
                    document.getElementById('searching-passengers').style.display = 'none';
                    document.getElementById('ride-request').style.display = 'none';
                }
            });
            
            // Solicitar viaje
            document.getElementById('request-btn').addEventListener('click', function() {
                if (!destinationLocation) {
                    showToast('Destino requerido', 'Por favor, selecciona un destino para tu viaje', 'warning');
                    return;
                }
                
                // Crear solicitud de viaje real
                const rideRequest = {
                    pickup: pickupLocation,
                    destination: destinationLocation,
                    price: document.getElementById('price-display').textContent,
                    pickupAddress: isManualMarkerMode ? manualPickupAddress : document.getElementById('pickup').value,
                    destinationAddress: isManualMarkerMode ? manualDestinationAddress : document.getElementById('destination').value,
                    timestamp: new Date(),
                    isManual: isManualMarkerMode
                };
                
                pendingRideRequests.push(rideRequest);
                
                bottomSheet.classList.add('expanded');
                expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                
                document.getElementById('request-form').style.display = 'none';
                document.getElementById('searching-loading').style.display = 'block';
                
                // Enviar solicitudes a conductores
                sendRideRequestsToDrivers();
                
                setTimeout(() => {
                    document.getElementById('searching-loading').style.display = 'none';
                    document.getElementById('offers-panel').style.display = 'block';
                    showToast('Conductores encontrados', 'Selecciona una oferta para tu viaje', 'success');
                    
                    // Crear ofertas de ejemplo
                    createSampleOffers();
                }, 2000);
            });
            
            // Aceptar oferta
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('btn-accept')) {
                    const driverName = e.target.getAttribute('data-driver');
                    const driverPrice = e.target.getAttribute('data-price');
                    
                    // Simular conductor aceptando
                    currentDriver = {
                        name: driverName,
                        price: driverPrice,
                        location: userLocation,
                        rating: 4.8,
                        trips: 120
                    };
                    
                    document.getElementById('offers-panel').style.display = 'none';
                    document.getElementById('ride-in-progress').style.display = 'block';
                    document.getElementById('pickup-location').textContent = document.getElementById('pickup').value;
                    
                    document.querySelector('.driver-arrival').textContent = `${driverName} está en camino`;
                    
                    // Mostrar detalles del conductor
                    showDriverDetails(currentDriver);
                    
                    // Cambiar estado del viaje
                    rideState = 'driver_accepted';
                    
                    // Ocultar formulario de solicitud
                    document.getElementById('request-form').style.display = 'none';
                    
                    // Mostrar ruta del conductor
                    simulateDriverRoute();
                    
                    showToast('Viaje confirmado', `${driverName} llegará en aproximadamente 5 minutos`, 'success');
                }
            });
            
            // Botón de ubicación actual
            document.getElementById('current-location').addEventListener('click', function() {
                if (map) {
                    map.setCenter(userLocation);
                    map.setZoom(16);
                    showToast('Ubicación actual', 'Centrando mapa en tu ubicación', 'info', 2000);
                }
            });
            
            // Controles de zoom
            document.getElementById('zoom-in').addEventListener('click', function() {
                if (map) {
                    map.setZoom(map.getZoom() + 1);
                }
            });
            
            document.getElementById('zoom-out').addEventListener('click', function() {
                if (map) {
                    map.setZoom(map.getZoom() - 1);
                }
            });
            
            // Botón de reintentar conexión
            document.getElementById('retry-map').addEventListener('click', function() {
                document.getElementById('map-error').style.display = 'none';
                document.getElementById('status-text').textContent = 'Reintentando conexión...';
                document.getElementById('status-dot').style.background = '#ffc107';
                
                setTimeout(() => {
                    initMap();
                }, 1000);
            });
            
            // Botón de reintentar ubicación
            document.getElementById('location-retry').addEventListener('click', function() {
                locationRequested = false;
                getUserLocation();
            });
            
            // Botón de marcadores manuales
            document.getElementById('manual-marker').addEventListener('click', function() {
                isManualMarkerMode = !isManualMarkerMode;
                
                if (isManualMarkerMode) {
                    // Activar modo manual
                    this.classList.add('manual-marker-active');
                    
                    // Desactivar la ubicación actual
                    document.getElementById('pickup').value = "";
                    pickupLocation = null;
                    
                    // Limpiar marcadores existentes
                    if (pickupMarker) {
                        pickupMarker.setMap(null);
                        pickupMarker = null;
                    }
                    if (destinationMarker) {
                        destinationMarker.setMap(null);
                        destinationMarker = null;
                    }
                    
                    // Mostrar información de marcadores manuales
                    document.getElementById('manual-marker-info').style.display = 'block';
                    
                    showToast('Marcadores manuales', 'Haz clic en el mapa para colocar origen y destino', 'info');
                    setupManualMarkers();
                } else {
                    // Desactivar modo manual
                    this.classList.remove('manual-marker-active');
                    
                    // Restaurar ubicación actual
                    document.getElementById('pickup').value = isUsingFallbackLocation ? 
                        "Ubicación aproximada (Cartagena)" : "Mi ubicación actual";
                    pickupLocation = userLocation;
                    
                    // Ocultar información de marcadores manuales
                    document.getElementById('manual-marker-info').style.display = 'none';
                    
                    removeManualMarkerListeners();
                    showToast('Marcadores automáticos', 'Se ha restaurado tu ubicación actual', 'info');
                }
            });
            
            // Aceptar solicitud de viaje (conductor)
            document.getElementById('accept-request').addEventListener('click', function() {
                if (currentRideRequest) {
                    document.getElementById('ride-request').style.display = 'none';
                    document.getElementById('active-ride').style.display = 'block';
                    document.getElementById('searching-passengers').style.display = 'none';
                    
                    // Cambiar estado del viaje
                    rideState = 'driver_accepted';
                    
                    // Calcular ruta hacia el pasajero
                    calculateRouteToPassenger(currentRideRequest.pickup);
                    
                    // Mostrar información del viaje
                    document.getElementById('active-ride-locations').textContent = 
                        `De: ${currentRideRequest.pickupAddress} - A: ${currentRideRequest.destinationAddress}`;
                    
                    // Crear objeto de viaje activo
                    activeRide = {
                        ...currentRideRequest,
                        driver: userData,
                        acceptedAt: new Date()
                    };
                    
                    // Enviar notificación al pasajero
                    sendRideAcceptedNotification(activeRide);
                    
                    showToast('Viaje aceptado', 'Dirígete al punto de recogida', 'success');
                }
            });
            
            // Rechazar solicitud de viaje (conductor)
            document.getElementById('reject-request').addEventListener('click', function() {
                document.getElementById('ride-request').style.display = 'none';
                currentRideRequest = null;
                showToast('Solicitud rechazada', 'Puedes aceptar otras solicitudes', 'info');
            });
            
            // Botón para abrir Google Maps
            document.getElementById('open-google-maps').addEventListener('click', function() {
                if (currentRideRequest && currentRideRequest.pickup) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${currentRideRequest.pickup.lat},${currentRideRequest.pickup.lng}&travelmode=driving`;
                    window.open(url, '_blank');
                    showToast('Google Maps', 'Abriendo en aplicación externa', 'info', 2000);
                }
            });
            
            // Toggle de tema
            document.getElementById('theme-toggle').addEventListener('click', function() {
                isNightMode = !isNightMode;
                applyNightMode();
                const mode = isNightMode ? 'nocturno' : 'diurno';
                showToast('Modo ' + mode, 'Tema cambiado exitosamente', 'info', 2000);
            });
            
            // Botón para aplicar verificación
            document.getElementById('btn-apply-verification').addEventListener('click', function() {
                showVerificationForm();
            });
            
            // Botón para volver desde el panel de administración
            document.getElementById('admin-back-btn').addEventListener('click', function() {
                // Cerrar sesión y volver al login
                auth.signOut().then(() => {
                    document.getElementById('admin-panel').style.display = 'none';
                    document.getElementById('auth-container').style.display = 'flex';
                    showToast('Sesión cerrada', 'Has salido del modo administrador', 'info');
                });
            });
            
            // Botón para volver desde el formulario de verificación
            document.getElementById('verification-back-btn').addEventListener('click', function() {
                document.getElementById('verification-container').classList.remove('active');
                document.getElementById('app-container').style.display = 'flex';
            });
            
            // Cerrar modal de imagen
            document.getElementById('image-modal-close').addEventListener('click', function() {
                document.getElementById('image-modal').classList.remove('active');
            });
            
            // Configurar eventos para subir fotos
            setupPhotoUploadEvents();
            
            // Validar formulario de verificación
            setupVerificationFormValidation();
            
            // Botón "Ya Llegué" del conductor
            document.getElementById('arrived-btn').addEventListener('click', function() {
                rideState = 'driver_arrived';
                document.getElementById('arrived-btn').style.display = 'none';
                document.getElementById('start-ride').style.display = 'flex';
                
                // Mostrar cuenta regresiva al pasajero
                if (isDriverMode) {
                    // En una app real, esto se enviaría al pasajero
                    document.getElementById('arrival-countdown').style.display = 'block';
                    startArrivalCountdown();
                }
                
                showToast('Llegada confirmada', 'El pasajero ha sido notificado de tu llegada', 'success');
            });
            
            // Botón "Iniciar Viaje"
            document.getElementById('start-ride').addEventListener('click', function() {
                rideState = 'ride_started';
                document.getElementById('start-ride').style.display = 'none';
                document.getElementById('complete-ride').style.display = 'flex';
                
                // Mostrar botón de iniciar viaje al pasajero
                if (isDriverMode) {
                    // En una app real, esto se enviaría al pasajero
                    document.getElementById('start-ride-passenger').style.display = 'flex';
                }
                
                showToast('Viaje iniciado', 'El viaje ha comenzado', 'success');
            });
            
            // Botón "Iniciar Viaje" del pasajero
            document.getElementById('start-ride-passenger').addEventListener('click', function() {
                document.getElementById('start-ride-passenger').style.display = 'none';
                document.getElementById('complete-ride-passenger').style.display = 'flex';
                showToast('Viaje iniciado', 'El viaje ha comenzado', 'success');
            });
            
            // Botón "Finalizar Viaje" del conductor
            document.getElementById('complete-ride').addEventListener('click', function() {
                completeRide();
            });
            
            // Botón "Finalizar Viaje" del pasajero
            document.getElementById('complete-ride-passenger').addEventListener('click', function() {
                completeRide();
            });
            
            // Botón "Muy demorado"
            document.getElementById('btn-delayed').addEventListener('click', function() {
                showToast('Notificación enviada', 'El conductor ha sido notificado de tu demora', 'info');
            });
            
            // Botón "Cancelar" durante la cuenta regresiva
            document.getElementById('btn-cancel-ride').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas cancelar el viaje?')) {
                    resetApp();
                    showToast('Viaje cancelado', 'El viaje ha sido cancelado', 'warning');
                }
            });
            
            // Botón "Solicitar Nuevo Viaje" después de completar
            document.getElementById('btn-new-ride').addEventListener('click', function() {
                resetApp();
            });
            
            // Botón "Volver a Buscar" del conductor
            document.getElementById('btn-new-ride-driver').addEventListener('click', function() {
                resetDriverApp();
            });
        }

        // Mostrar detalles del conductor al pasajero
        function showDriverDetails(driver) {
            const detailsPanel = document.getElementById('driver-details-panel');
            const driverAvatar = document.getElementById('driver-details-avatar');
            const driverName = document.getElementById('driver-details-name');
            const driverRating = document.getElementById('driver-details-rating');
            const driverVehicle = document.getElementById('driver-details-vehicle');
            const driverPlate = document.getElementById('driver-details-plate');
            const driverColor = document.getElementById('driver-details-color');
            const driverYear = document.getElementById('driver-details-year');
            const driverVehiclePhoto = document.getElementById('driver-details-vehicle-photo');
            
            // Simular datos del conductor (en una app real, estos vendrían de la base de datos)
            driverName.textContent = driver.name;
            driverRating.innerHTML = `<i class="fas fa-star"></i> ${driver.rating} (${driver.trips} viajes)`;
            driverVehicle.textContent = "Toyota Corolla";
            driverPlate.textContent = "ABC123";
            driverColor.textContent = "Negro";
            driverYear.textContent = "2022";
            
            // Simular foto del vehículo
            driverVehiclePhoto.innerHTML = '<i class="fas fa-car" style="font-size: 48px; color: var(--gray);"></i>';
            
            // Mostrar el panel de detalles
            detailsPanel.style.display = 'block';
        }

        // Mostrar formulario de verificación
        function showVerificationForm() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('verification-container').classList.add('active');
        }

        // Configurar eventos para subir fotos
        function setupPhotoUploadEvents() {
            // Foto de perfil
            document.getElementById('capture-profile-photo').addEventListener('click', () => {
                document.getElementById('profile-photo-input').click();
            });
            
            document.getElementById('profile-photo-input').addEventListener('change', (e) => {
                handleImageUpload(e, 'profile-photo-preview', 'profilePhoto');
            });
            
            // SOAT
            document.getElementById('upload-soat').addEventListener('click', () => {
                document.getElementById('soat-input').click();
            });
            
            document.getElementById('soat-input').addEventListener('change', (e) => {
                handleImageUpload(e, 'soat-preview', 'soat');
            });
            
            // Tecnomecánica
            document.getElementById('upload-tecno').addEventListener('click', () => {
                document.getElementById('tecno-input').click();
            });
            
            document.getElementById('tecno-input').addEventListener('change', (e) => {
                handleImageUpload(e, 'tecno-preview', 'tecnomecanica');
            });
            
            // Foto del vehículo
            document.getElementById('upload-vehicle-photo').addEventListener('click', () => {
                document.getElementById('vehicle-photo-input').click();
            });
            
            document.getElementById('vehicle-photo-input').addEventListener('change', (e) => {
                handleImageUpload(e, 'vehicle-photo-preview', 'vehiclePhoto');
            });
        }

        // Manejar subida de imágenes
        function handleImageUpload(event, previewId, dataKey) {
            const file = event.target.files[0];
            if (file) {
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    showToast('Error', 'Por favor, selecciona solo archivos de imagen', 'error');
                    return;
                }
                
                // Validar tamaño (máximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Error', 'La imagen es demasiado grande (máximo 5MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<img src="${e.target.result}" alt="Imagen cargada" style="width: 100%; height: 100%; object-fit: cover;">`;
                    
                    // Guardar la imagen en los datos de verificación
                    verificationData[dataKey] = e.target.result;
                    
                    // Validar formulario
                    validateVerificationForm();
                    
                    showToast('Imagen cargada', 'Imagen subida correctamente', 'success', 2000);
                };
                reader.onerror = function() {
                    showToast('Error', 'Error al cargar la imagen', 'error');
                };
                reader.readAsDataURL(file);
            }
        }

        // Configurar validación del formulario de verificación
        function setupVerificationFormValidation() {
            // Validar cuando cambien los campos
            const formInputs = document.querySelectorAll('#verification-container input, #verification-container textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', validateVerificationForm);
            });
            
            // Validar cuando cambien los checkboxes
            const checkboxes = document.querySelectorAll('#verification-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', validateVerificationForm);
            });
            
            // Validar año del vehículo
            document.getElementById('vehicle-year').addEventListener('input', function() {
                const year = parseInt(this.value);
                const validationElement = document.getElementById('year-validation');
                
                if (year < 2000) {
                    validationElement.textContent = 'Solo se permiten vehículos desde el año 2000';
                    validationElement.className = 'year-validation error';
                } else {
                    validationElement.textContent = 'Año válido';
                    validationElement.className = 'year-validation success';
                }
                
                validateVerificationForm();
            });
            
            // Validar placa del vehículo
            document.getElementById('vehicle-plate').addEventListener('input', function() {
                const plate = this.value.toUpperCase();
                this.value = plate;
                
                // Verificar si la placa está en lista negra
                if (isPlateBlacklisted(plate)) {
                    showToast('Placa en lista negra', 'Esta placa no puede ser registrada como conductor', 'error');
                    this.setCustomValidity('Placa en lista negra');
                } else {
                    this.setCustomValidity('');
                }
                
                validateVerificationForm();
            });
            
            // Configurar envío del formulario
            document.getElementById('btn-submit-verification').addEventListener('click', submitVerificationForm);
        }

        // Validar formulario de verificación
        function validateVerificationForm() {
            const fullName = document.getElementById('driver-full-name').value;
            const idNumber = document.getElementById('driver-id-number').value;
            const birthDate = document.getElementById('driver-birth-date').value;
            const vehicleBrand = document.getElementById('vehicle-brand').value;
            const vehicleYear = document.getElementById('vehicle-year').value;
            const vehicleColor = document.getElementById('vehicle-color').value;
            const vehiclePlate = document.getElementById('vehicle-plate').value;
            const acceptTerms = document.getElementById('accept-terms').checked;
            
            // Verificar que todas las imágenes estén cargadas
            const allImagesLoaded = 
                verificationData.profilePhoto && 
                verificationData.soat && 
                verificationData.tecnomecanica &&
                verificationData.vehiclePhoto;
            
            // Verificar que todos los campos estén completos
            const allFieldsFilled = 
                fullName && 
                idNumber && 
                birthDate && 
                vehicleBrand && 
                vehicleYear && 
                vehicleColor &&
                vehiclePlate;
            
            // Verificar que el año sea válido
            const yearValid = parseInt(vehicleYear) >= 2000;
            
            // Verificar que la placa no esté en lista negra
            const plateValid = !isPlateBlacklisted(vehiclePlate);
            
            // Habilitar o deshabilitar el botón de envío
            const submitButton = document.getElementById('btn-submit-verification');
            if (allFieldsFilled && allImagesLoaded && acceptTerms && yearValid && plateValid) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        // Enviar formulario de verificación
        function submitVerificationForm() {
            const user = auth.currentUser;
            if (!user) {
                showToast('Error', 'Debes iniciar sesión para enviar la verificación', 'error');
                return;
            }

            // Mostrar carga
            const submitButton = document.getElementById('btn-submit-verification');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            submitButton.disabled = true;

            // Recopilar datos del formulario
            const formData = {
                userId: user.uid,
                fullName: document.getElementById('driver-full-name').value,
                idNumber: document.getElementById('driver-id-number').value,
                birthDate: document.getElementById('driver-birth-date').value,
                vehicleBrand: document.getElementById('vehicle-brand').value,
                vehicleYear: parseInt(document.getElementById('vehicle-year').value),
                vehicleColor: document.getElementById('vehicle-color').value,
                vehiclePlate: document.getElementById('vehicle-plate').value.toUpperCase(),
                profilePhoto: verificationData.profilePhoto,
                soat: verificationData.soat,
                tecnomecanica: verificationData.tecnomecanica,
                vehiclePhoto: verificationData.vehiclePhoto,
                email: user.email,
                phone: user.phoneNumber || 'No proporcionado',
                status: 'pending',
                appliedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            console.log('Enviando solicitud de verificación:', formData);

            // Guardar en Firestore
            db.collection('driverApplications').add(formData)
                .then((docRef) => {
                    console.log('Solicitud guardada con ID:', docRef.id);
                    
                    // Actualizar estado del usuario
                    return db.collection('users').doc(user.uid).update({
                        hasAppliedForVerification: true,
                        verificationStatus: 'pending'
                    });
                })
                .then(() => {
                    console.log('Estado de usuario actualizado');
                    
                    // Éxito
                    showToast('Solicitud Enviada', 'Tu solicitud de verificación ha sido enviada. Te notificaremos una vez sea revisada.', 'success');
                    
                    // Cerrar formulario y volver a la app
                    document.getElementById('verification-container').classList.remove('active');
                    document.getElementById('app-container').style.display = 'flex';
                    
                    // Actualizar UI
                    hasAppliedForVerification = true;
                    updateDriverUI();
                    
                    // Limpiar formulario
                    resetVerificationForm();
                })
                .catch((error) => {
                    console.error('Error enviando solicitud:', error);
                    showToast('Error', 'No se pudo enviar la solicitud: ' + error.message, 'error');
                    
                    // Restaurar botón
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                });
        }

        // Función para limpiar el formulario de verificación
        function resetVerificationForm() {
            // Limpiar campos de texto
            document.getElementById('driver-full-name').value = '';
            document.getElementById('driver-id-number').value = '';
            document.getElementById('driver-birth-date').value = '';
            document.getElementById('vehicle-brand').value = '';
            document.getElementById('vehicle-year').value = '';
            document.getElementById('vehicle-color').value = '';
            document.getElementById('vehicle-plate').value = '';
            
            // Limpiar checkboxes
            document.getElementById('accept-terms').checked = false;
            
            // Limpiar previsualizaciones de imágenes
            const previewIds = [
                'profile-photo-preview',
                'soat-preview',
                'tecno-preview',
                'vehicle-photo-preview'
            ];
            
            previewIds.forEach(previewId => {
                const preview = document.getElementById(previewId);
                preview.innerHTML = `
                    <div class="photo-upload-placeholder">
                        <i class="fas fa-${previewId.includes('profile') ? 'user' : previewId.includes('vehicle') ? 'car' : 'file-alt'}"></i>
                        <div>${getPreviewTitle(previewId)}</div>
                    </div>
                `;
            });
            
            // Limpiar datos de verificación
            verificationData = {
                profilePhoto: null,
                soat: null,
                tecnomecanica: null,
                vehiclePhoto: null
            };
        }

        function getPreviewTitle(previewId) {
            const titles = {
                'profile-photo-preview': 'Foto de Perfil',
                'soat-preview': 'SOAT',
                'tecno-preview': 'Tecnomecánica',
                'vehicle-photo-preview': 'Foto del Vehículo'
            };
            return titles[previewId] || 'Imagen';
        }

        // Abrir modal de imagen
        function openImageModal(imageSrc) {
            document.getElementById('modal-image').src = imageSrc;
            document.getElementById('image-modal').classList.add('active');
        }

        // Enviar solicitudes de viaje a conductores
        function sendRideRequestsToDrivers() {
            if (pendingRideRequests.length > 0 && driverStatus) {
                const latestRequest = pendingRideRequests[pendingRideRequests.length - 1];
                currentRideRequest = latestRequest;
                
                document.getElementById('request-price').textContent = `$${latestRequest.price} COP`;
                document.getElementById('request-locations').textContent = 
                    `De: ${latestRequest.pickupAddress} - A: ${latestRequest.destinationAddress}`;
                
                // Mostrar detalles adicionales si es modo manual
                if (latestRequest.isManual) {
                    document.getElementById('driver-route-details').style.display = 'block';
                    document.getElementById('driver-pickup-address').textContent = latestRequest.pickupAddress;
                    document.getElementById('driver-destination-address').textContent = latestRequest.destinationAddress;
                } else {
                    document.getElementById('driver-route-details').style.display = 'none';
                }
                
                document.getElementById('ride-request').style.display = 'block';
                showToast('Nueva solicitud', 'Tienes una nueva solicitud de viaje', 'info');
            }
        }

        // Configurar marcadores manuales
        function setupManualMarkers() {
            manualMarkerClickListener = map.addListener('click', function(event) {
                if (!isManualMarkerMode) return;
                
                const clickLocation = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };
                
                if (!pickupLocation) {
                    // Primer clic: establecer origen
                    pickupLocation = clickLocation;
                    addPickupMarker(pickupLocation);
                    
                    // Mostrar mensaje de carga
                    document.getElementById('pickup').value = "Obteniendo dirección...";
                    
                    // Geocodificar para obtener dirección
                    geocodeLatLng(clickLocation, (address) => {
                        document.getElementById('pickup').value = address;
                        manualPickupAddress = address;
                        document.getElementById('manual-pickup-address').textContent = address;
                    });
                    
                    showToast('Origen establecido', 'Ahora haz clic para establecer el destino', 'info');
                } else if (!destinationLocation) {
                    // Segundo clic: establecer destino
                    destinationLocation = clickLocation;
                    addDestinationMarker(destinationLocation);
                    
                    // Mostrar mensaje de carga
                    document.getElementById('destination').value = "Obteniendo dirección...";
                    
                    // Geocodificar para obtener dirección
                    geocodeLatLng(clickLocation, (address) => {
                        document.getElementById('destination').value = address;
                        manualDestinationAddress = address;
                        document.getElementById('manual-destination-address').textContent = address;
                        calculateRoute();
                    });
                    
                    showToast('Destino establecido', 'Ruta calculada. Puedes solicitar tu viaje', 'success');
                }
            });
        }

        // Remover listeners de marcadores manuales
        function removeManualMarkerListeners() {
            if (manualMarkerClickListener) {
                google.maps.event.removeListener(manualMarkerClickListener);
                manualMarkerClickListener = null;
            }
        }

        // Cambiar a modo conductor
        function switchToDriverMode() {
            isDriverMode = true;
            document.getElementById('passenger-panel').style.display = 'none';
            document.getElementById('driver-panel').style.display = 'block';
            
            // Actualizar UI según estado de verificación
            updateDriverUI();
            
            // Actualizar marcador del usuario para modo conductor
            if (userMarker) {
                userMarker.setMap(null);
                
                const driverIcon = {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#28a745" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                };
                
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: driverIcon,
                    title: 'Tú (Conductor)'
                });
            }
        }

        // Cambiar a modo pasajero
        function switchToPassengerMode() {
            isDriverMode = false;
            document.getElementById('driver-panel').style.display = 'none';
            document.getElementById('passenger-panel').style.display = 'block';
            resetApp();
            
            // Restaurar marcador normal del usuario
            if (userMarker) {
                userMarker.setMap(null);
                addUserMarker();
            }
        }

        // Simular movimiento de conductores
        function simulateDrivers() {
            setInterval(() => {
                drivers.forEach((driver) => {
                    const latChange = (Math.random() - 0.5) * 0.001;
                    const lngChange = (Math.random() - 0.5) * 0.001;
                    
                    const newLocation = {
                        lat: driver.location.lat + latChange,
                        lng: driver.location.lng + lngChange
                    };
                    
                    driver.location = newLocation;
                    
                    if (driver.marker) {
                        driver.marker.setPosition(newLocation);
                    }
                });
            }, 5000);
        }

        // Simular ruta del conductor
        function simulateDriverRoute() {
            if (!driverMarker) {
                // Crear marcador del conductor
                const driverIcon = {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#28a745" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                };
                
                driverMarker = new google.maps.Marker({
                    position: { lat: userLocation.lat + 0.01, lng: userLocation.lng + 0.01 },
                    map: map,
                    icon: driverIcon,
                    title: 'Conductor en camino'
                });
            }
            
            // Calcular ruta del conductor hacia el pasajero
            const driverLocation = { lat: userLocation.lat + 0.01, lng: userLocation.lng + 0.01 };
            
            const request = {
                origin: driverLocation,
                destination: pickupLocation,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Simular movimiento del conductor
                    simulateDriverMovement(driverLocation, pickupLocation);
                }
            });
        }

        // Simular movimiento del conductor hacia el pasajero
        function simulateDriverMovement(startLocation, endLocation) {
            const steps = 50;
            const latStep = (endLocation.lat - startLocation.lat) / steps;
            const lngStep = (endLocation.lng - startLocation.lng) / steps;
            let currentStep = 0;
            
            const moveInterval = setInterval(() => {
                if (currentStep < steps) {
                    const newLocation = {
                        lat: startLocation.lat + (latStep * currentStep),
                        lng: startLocation.lng + (lngStep * currentStep)
                    };
                    
                    if (driverMarker) {
                        driverMarker.setPosition(newLocation);
                    }
                    
                    currentStep++;
                } else {
                    clearInterval(moveInterval);
                    // Cuando el conductor llega, mostrar botón "Ya Llegué"
                    if (isDriverMode) {
                        document.getElementById('arrived-btn').style.display = 'flex';
                    } else {
                        // Para el pasajero, mostrar que el conductor ha llegado
                        document.getElementById('arrival-countdown').style.display = 'block';
                        startArrivalCountdown();
                    }
                }
            }, 100);
        }

        // Calcular ruta hacia el pasajero (conductor)
        function calculateRouteToPassenger(passengerLocation) {
            const request = {
                origin: userLocation,
                destination: passengerLocation,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    updateRouteInfo(result);
                }
            });
        }

        // Iniciar cuenta regresiva de llegada
        function startArrivalCountdown() {
            arrivalCountdown = 300; // 5 minutos en segundos
            
            arrivalCountdownInterval = setInterval(() => {
                arrivalCountdown--;
                
                const minutes = Math.floor(arrivalCountdown / 60);
                const seconds = arrivalCountdown % 60;
                document.getElementById('countdown-timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                if (arrivalCountdown <= 0) {
                    clearInterval(arrivalCountdownInterval);
                    document.getElementById('arrival-countdown').style.display = 'none';
                    showToast('Tiempo agotado', 'El tiempo de espera ha finalizado', 'warning');
                }
            }, 1000);
        }

        // Completar viaje
        function completeRide() {
            rideState = 'ride_completed';
            
            // Detener contadores
            if (countdownInterval) clearInterval(countdownInterval);
            if (arrivalCountdownInterval) clearInterval(arrivalCountdownInterval);
            
            // Mostrar pantalla de viaje completado
            if (isDriverMode) {
                document.getElementById('active-ride').style.display = 'none';
                document.getElementById('driver-ride-completed').style.display = 'block';
            } else {
                document.getElementById('ride-in-progress').style.display = 'none';
                document.getElementById('ride-completed').style.display = 'block';
            }
            
            showToast('¡Viaje completado!', 'Gracias por usar Twogo', 'success');
        }

        // Iniciar cuenta regresiva
        function startCountdown(minutes) {
            let seconds = minutes * 60;
            const etaElement = document.getElementById('driver-eta');
            
            countdownInterval = setInterval(() => {
                seconds--;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    etaElement.textContent = '¡Llegó!';
                } else {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    etaElement.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                }
            }, 1000);
        }

        // Resetear aplicación
        function resetApp() {
            rideState = 'idle';
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            if (arrivalCountdownInterval) {
                clearInterval(arrivalCountdownInterval);
            }
            
            document.getElementById('ride-in-progress').style.display = 'none';
            document.getElementById('request-form').style.display = 'block';
            document.getElementById('offers-panel').style.display = 'none';
            document.getElementById('destination').value = '';
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('manual-marker-info').style.display = 'none';
            document.getElementById('driver-details-panel').style.display = 'none';
            document.getElementById('arrival-countdown').style.display = 'none';
            document.getElementById('ride-completed').style.display = 'none';
            document.getElementById('start-ride-passenger').style.display = 'none';
            document.getElementById('complete-ride-passenger').style.display = 'none';
            
            // Remover ruta del mapa
            directionsRenderer.setMap(null);
            
            if (pickupMarker) {
                pickupMarker.setMap(null);
                pickupMarker = null;
            }
            
            if (destinationMarker) {
                destinationMarker.setMap(null);
                destinationMarker = null;
            }
            
            if (driverMarker) {
                driverMarker.setMap(null);
                driverMarker = null;
            }
            
            destinationLocation = null;
            pickupLocation = userLocation;
            
            // Reactivar directions renderer
            directionsRenderer.setMap(map);
        }

        // Resetear aplicación del conductor
        function resetDriverApp() {
            rideState = 'idle';
            currentRideRequest = null;
            activeRide = null;
            
            document.getElementById('active-ride').style.display = 'none';
            document.getElementById('driver-ride-completed').style.display = 'none';
            document.getElementById('searching-passengers').style.display = 'block';
            document.getElementById('arrived-btn').style.display = 'flex';
            document.getElementById('start-ride').style.display = 'none';
            document.getElementById('complete-ride').style.display = 'none';
            
            // Remover ruta del mapa
            directionsRenderer.setMap(null);
            
            // Reactivar directions renderer
            directionsRenderer.setMap(map);
        }

        // Crear ofertas de ejemplo
        function createSampleOffers() {
            const offersPanel = document.getElementById('offers-panel');
            offersPanel.innerHTML = '<div class="offers-title">Ofertas de conductores</div>';
            
            const sampleDrivers = [
                { name: 'Juan Díaz', price: '7.000', rating: 4.8, trips: 120, time: '5 min' },
                { name: 'María Pérez', price: '8.500', rating: 4.9, trips: 85, time: '3 min' },
                { name: 'Carlos López', price: '9.000', rating: 4.7, trips: 200, time: '7 min' }
            ];
            
            sampleDrivers.forEach(driver => {
                const offerCard = document.createElement('div');
                offerCard.className = 'offer-card';
                offerCard.innerHTML = `
                    <div class="driver-avatar">${driver.name.split(' ').map(n => n[0]).join('')}</div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i> ${driver.rating} (${driver.trips} viajes)
                        </div>
                    </div>
                    <div class="offer-details">
                        <div class="offer-price">$${driver.price} COP</div>
                        <div class="offer-time">${driver.time}</div>
                        <button class="btn-accept" data-driver="${driver.name}" data-price="${driver.price}">
                            <i class="fas fa-check"></i> Aceptar
                        </button>
                    </div>
                `;
                offersPanel.appendChild(offerCard);
            });
        }

        // Limpiar cuando se cierre la página
        window.addEventListener('beforeunload', function() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
        });

        // Firebase Authentication Functions
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Ocultar mensajes de éxito
            const successElement = elementId.replace('error', 'success');
            if (document.getElementById(successElement)) {
                document.getElementById(successElement).style.display = 'none';
            }
        }

        function showSuccess(elementId, message) {
            const successElement = document.getElementById(elementId);
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // Ocultar mensajes de error
            const errorElement = elementId.replace('success', 'error');
            if (document.getElementById(errorElement)) {
                document.getElementById(errorElement).style.display = 'none';
            }
        }

        function hideMessages(formId) {
            const errorElement = document.getElementById(`${formId}-error`);
            const successElement = document.getElementById(`${formId}-success`);
            
            if (errorElement) errorElement.style.display = 'none';
            if (successElement) successElement.style.display = 'none';
        }

        function saveUserToFirestore(user, additionalData = {}) {
            return db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                displayName: additionalData.displayName || user.displayName || '',
                phoneNumber: additionalData.phoneNumber || user.phoneNumber || '',
                photoURL: additionalData.photoURL || user.photoURL || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                isAdmin: additionalData.isAdmin || false,
                isDriver: additionalData.isDriver || false,
                isDriverVerified: additionalData.isDriverVerified || false,
                hasAppliedForVerification: additionalData.hasAppliedForVerification || false
            }, { merge: true });
        }

        function updateUserAvatar(user) {
            const userAvatar = document.getElementById('user-avatar');
            if (user.photoURL) {
                userAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName || 'Usuario'}">`;
            } else {
                const initials = user.displayName ? 
                    user.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : 
                    user.email[0].toUpperCase();
                userAvatar.innerHTML = initials;
            }
        }

        // Verificar si es de noche (después de las 6 PM)
        function isNightTime() {
            const now = new Date();
            const hour = now.getHours();
            return hour >= 18 || hour < 6;
        }

        // Aplicar modo nocturno
        function applyNightMode() {
            const appContainer = document.getElementById('app-container');
            const themeIcon = document.getElementById('theme-icon');
            
            if (isNightMode) {
                appContainer.classList.add('night-mode');
                themeIcon.className = 'fas fa-sun';
            } else {
                appContainer.classList.remove('night-mode');
                themeIcon.className = 'fas fa-moon';
            }
        }

        // Geocodificar coordenadas a dirección
        function geocodeLatLng(latLng, callback) {
            if (!geocoder) {
                geocoder = new google.maps.Geocoder();
            }
            
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === 'OK') {
                    if (results[0]) {
                        // Obtener la dirección formateada
                        const address = results[0].formatted_address;
                        callback(address);
                    } else {
                        callback('Dirección no encontrada');
                    }
                } else {
                    console.warn('Geocoder falló debido a: ' + status);
                    callback('Error obteniendo dirección');
                }
            });
        }

        // Sistema de Lista Negra
        function loadBlacklist() {
            db.collection('blacklist').get()
                .then((querySnapshot) => {
                    blacklist = [];
                    const blacklistContainer = document.getElementById('blacklist-items');
                    blacklistContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        blacklistContainer.innerHTML = '<div class="no-applications"><i class="fas fa-ban"></i><div>No hay placas en lista negra</div></div>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        item.id = doc.id;
                        blacklist.push(item);
                        
                        const blacklistItem = document.createElement('div');
                        blacklistItem.className = 'blacklist-item';
                        blacklistItem.innerHTML = `
                            <div>
                                <div class="blacklist-plate">${item.plate}</div>
                                <div class="blacklist-reason">${item.reason}</div>
                            </div>
                            <button class="btn-remove-blacklist" data-id="${doc.id}">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        `;
                        
                        blacklistItem.querySelector('.btn-remove-blacklist').addEventListener('click', () => {
                            removeFromBlacklist(doc.id);
                        });
                        
                        blacklistContainer.appendChild(blacklistItem);
                    });
                })
                .catch((error) => {
                    console.error('Error cargando lista negra:', error);
                });
        }

        function addToBlacklist(plate, reason) {
            // Verificar si ya existe
            if (isPlateBlacklisted(plate)) {
                showToast('Placa ya en lista negra', 'Esta placa ya está en la lista negra', 'warning');
                return;
            }
            
            db.collection('blacklist').add({
                plate: plate.toUpperCase(),
                reason: reason,
                addedBy: auth.currentUser.uid,
                addedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showToast('Placa agregada', `La placa ${plate} ha sido agregada a la lista negra`, 'success');
                loadBlacklist();
            })
            .catch((error) => {
                console.error('Error agregando a lista negra:', error);
                showToast('Error', 'No se pudo agregar la placa a la lista negra', 'error');
            });
        }

        function removeFromBlacklist(id) {
            db.collection('blacklist').doc(id).delete()
            .then(() => {
                showToast('Placa eliminada', 'La placa ha sido eliminada de la lista negra', 'success');
                loadBlacklist();
            })
            .catch((error) => {
                console.error('Error eliminando de lista negra:', error);
                showToast('Error', 'No se pudo eliminar la placa de la lista negra', 'error');
            });
        }

        function isPlateBlacklisted(plate) {
            return blacklist.some(item => item.plate === plate.toUpperCase());
        }

        // Sistema de Notificaciones
        function setupNotificationSystem() {
            // Configurar objetivos de notificación
            document.querySelectorAll('.notification-target').forEach(target => {
                target.addEventListener('click', function() {
                    document.querySelectorAll('.notification-target').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Configurar envío de notificaciones
            document.getElementById('btn-send-notification').addEventListener('click', sendNotificationToUsers);
        }

        function sendNotificationToUsers() {
            const message = document.getElementById('notification-message').value;
            const target = document.querySelector('.notification-target.active').getAttribute('data-target');
            
            if (!message.trim()) {
                showToast('Error', 'Por favor, escribe un mensaje para la notificación', 'error');
                return;
            }
            
            // Enviar notificación a todos los usuarios según el objetivo
            let userQuery = db.collection('users');
            
            if (target === 'passengers') {
                userQuery = userQuery.where('isDriver', '==', false);
            } else if (target === 'drivers') {
                userQuery = userQuery.where('isDriverVerified', '==', true);
            }
            
            userQuery.get()
                .then((querySnapshot) => {
                    const promises = [];
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        if (user.fcmToken) {
                            promises.push(sendPushNotification(user.uid, 'Notificación de Twogo', message));
                        }
                    });
                    
                    return Promise.all(promises);
                })
                .then(() => {
                    showToast('Notificación enviada', `La notificación ha sido enviada a los usuarios`, 'success');
                    document.getElementById('notification-message').value = '';
                })
                .catch((error) => {
                    console.error('Error enviando notificación:', error);
                    showToast('Error', 'No se pudo enviar la notificación: ' + error.message, 'error');
                });
        }

        function sendPushNotification(userId, title, body) {
            // En una implementación real, aquí se enviaría la notificación push
            // usando FCM (Firebase Cloud Messaging)
            console.log(`Enviando notificación a ${userId}: ${title} - ${body}`);
            
            // Simulación de envío de notificación
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Notificación enviada a ${userId}`);
                    resolve();
                }, 1000);
            });
        }

        function sendRideAcceptedNotification(ride) {
            // En una implementación real, aquí se enviaría una notificación al pasajero
            // informando que su viaje ha sido aceptado
            console.log(`Viaje aceptado: Conductor ${ride.driver.displayName} aceptó el viaje`);
            
            // Simulación de envío de notificación
            sendPushNotification('passenger_user_id', 'Viaje Aceptado', 
                `Tu viaje ha sido aceptado por ${ride.driver.displayName}. El conductor está en camino.`);
        }

        // Preloader y Auth System
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar lista negra
            document.getElementById('btn-add-blacklist').addEventListener('click', function() {
                const plate = document.getElementById('blacklist-plate').value;
                const reason = document.getElementById('blacklist-reason').value;
                
                if (!plate.trim()) {
                    showToast('Error', 'Por favor, ingresa una placa', 'error');
                    return;
                }
                
                if (!reason.trim()) {
                    showToast('Error', 'Por favor, ingresa un motivo', 'error');
                    return;
                }
                
                addToBlacklist(plate, reason);
                document.getElementById('blacklist-plate').value = '';
                document.getElementById('blacklist-reason').value = '';
            });
            
            // Verificar estado de autenticación primero
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Usuario ya está logueado, verificar si es admin
                    document.getElementById('preloader').style.display = 'none';
                    document.getElementById('auth-container').style.display = 'none';
                    
                    // Verificar y actualizar estado de administrador
                    checkAndUpdateAdminStatus(user);
                    
                } else {
                    // Usuario no está logueado, mostrar preloader y luego auth
                    setTimeout(function() {
                        document.getElementById('preloader').classList.add('hidden');
                        setTimeout(function() {
                            document.getElementById('preloader').style.display = 'none';
                            document.getElementById('auth-container').style.display = 'flex';
                        }, 500);
                    }, 3000);
                }
            });
            
            // Cambiar mensajes del preloader
            const messages = [
                "Nueva manera de moverte",
                "Viaja seguro y rápido",
                "Conectamos conductores y pasajeros",
                "Tu transporte personalizado"
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('preloader-message');
            
            setInterval(function() {
                messageIndex = (messageIndex + 1) % messages.length;
                messageElement.textContent = messages[messageIndex];
            }, 3000);
            
            // Auth Tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.getAttribute('data-tab') === 'login') {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('register-form').style.display = 'none';
                        hideMessages('login');
                    } else {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('register-form').style.display = 'block';
                        hideMessages('register');
                    }
                });
            });
            
            // Navegación entre login y registro
            document.getElementById('go-to-register').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.auth-tab[data-tab="register"]').classList.add('active');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
                hideMessages('login');
            });
            
            document.getElementById('go-to-login').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
                hideMessages('register');
            });
            
            // Cambiar foto de perfil
            document.querySelectorAll('.change-photo').forEach(button => {
                button.addEventListener('click', function() {
                    const formId = this.closest('.auth-form').id;
                    const uploadId = formId === 'register-form' ? 'photo-upload' : 'google-photo-upload';
                    document.getElementById(uploadId).click();
                });
            });
            
            document.getElementById('photo-upload').addEventListener('change', function(e) {
                handleImageUpload(e, 'profile-picture');
            });
            
            function handleImageUpload(event, profilePictureId) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const profilePicture = document.getElementById(profilePictureId);
                        profilePicture.innerHTML = `<img src="${e.target.result}" alt="Foto de perfil">`;
                        profilePicture.querySelector('.change-photo').innerHTML = '<i class="fas fa-camera"></i>';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // Login con correo
            document.getElementById('btn-login').addEventListener('click', function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    showError('login-error', 'Por favor, completa todos los campos.');
                    return;
                }
                
                hideMessages('login');
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Login exitoso
                        const user = userCredential.user;
                        showSuccess('login-success', 'Inicio de sesión exitoso!');
                        
                        // Verificar y actualizar estado de administrador
                        checkAndUpdateAdminStatus(user);
                    })
                    .catch((error) => {
                        console.error('Error en login:', error);
                        let errorMessage = 'Error al iniciar sesión. ';
                        
                        switch (error.code) {
                            case 'auth/invalid-email':
                                errorMessage += 'El correo electrónico no es válido.';
                                break;
                            case 'auth/user-disabled':
                                errorMessage += 'Esta cuenta ha sido deshabilitada.';
                                break;
                            case 'auth/user-not-found':
                                errorMessage += 'No existe una cuenta con este correo.';
                                break;
                            case 'auth/wrong-password':
                                errorMessage += 'La contraseña es incorrecta.';
                                break;
                            default:
                                errorMessage += 'Inténtalo de nuevo más tarde.';
                        }
                        
                        showError('login-error', errorMessage);
                    });
            });
            
            // Registro con correo
            document.getElementById('btn-register').addEventListener('click', function() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (!name || !email || !phone || !password || !confirmPassword) {
                    showError('register-error', 'Por favor, completa todos los campos.');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('register-error', 'Las contraseñas no coinciden.');
                    return;
                }
                
                if (password.length < 6) {
                    showError('register-error', 'La contraseña debe tener al menos 6 caracteres.');
                    return;
                }
                
                hideMessages('register');
                
                // Obtener foto de perfil si se cargó
                const profilePicture = document.getElementById('profile-picture');
                let photoURL = null;
                if (profilePicture.querySelector('img')) {
                    photoURL = profilePicture.querySelector('img').src;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Registro exitoso
                        const user = userCredential.user;
                        
                        // Actualizar perfil del usuario
                        return user.updateProfile({
                            displayName: name,
                            photoURL: photoURL
                        }).then(() => {
                            // Guardar datos adicionales en Firestore
                            return saveUserToFirestore(user, {
                                displayName: name,
                                phoneNumber: '+57 ' + phone,
                                photoURL: photoURL
                            });
                        });
                    })
                    .then(() => {
                        showSuccess('register-success', '¡Cuenta creada exitosamente!');
                        
                        // Obtener datos del usuario
                        const user = auth.currentUser;
                        userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: name,
                            phoneNumber: '+57 ' + phone,
                            photoURL: photoURL
                        };
                        
                        updateUserAvatar(userData);
                        
                        // Verificar estado de administrador
                        checkAndUpdateAdminStatus(user);
                    })
                    .catch((error) => {
                        console.error('Error en registro:', error);
                        let errorMessage = 'Error al crear la cuenta. ';
                        
                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                errorMessage += 'Ya existe una cuenta con este correo.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage += 'El correo electrónico no es válido.';
                                break;
                            case 'auth/weak-password':
                                errorMessage += 'La contraseña es demasiado débil.';
                                break;
                            default:
                                errorMessage += 'Inténtalo de nuevo más tarde.';
                        }
                        
                        showError('register-error', errorMessage);
                    });
            });
            
            // Login con Google
            document.getElementById('btn-google-login').addEventListener('click', function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // Login exitoso con Google
                        const user = result.user;
                        
                        // Guardar/actualizar datos en Firestore
                        return saveUserToFirestore(user);
                    })
                    .then(() => {
                        // Obtener datos del usuario
                        const user = auth.currentUser;
                        userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            phoneNumber: user.phoneNumber,
                            photoURL: user.photoURL
                        };
                        
                        updateUserAvatar(userData);
                        
                        // Verificar estado de administrador
                        checkAndUpdateAdminStatus(user);
                    })
                    .catch((error) => {
                        console.error('Error en login con Google:', error);
                        showError('login-error', 'Error al iniciar sesión con Google.');
                    });
            });
            
            // Registro con Google
            document.getElementById('btn-google-register').addEventListener('click', function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // Registro exitoso con Google
                        const user = result.user;
                        
                        // Guardar/actualizar datos en Firestore
                        return saveUserToFirestore(user);
                    })
                    .then(() => {
                        // Obtener datos del usuario
                        const user = auth.currentUser;
                        userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            phoneNumber: user.phoneNumber,
                            photoURL: user.photoURL
                        };
                        
                        updateUserAvatar(userData);
                        
                        // Verificar estado de administrador
                        checkAndUpdateAdminStatus(user);
                    })
                    .catch((error) => {
                        console.error('Error en registro con Google:', error);
                        showError('register-error', 'Error al registrarse con Google.');
                    });
            });
        });
    </script>
</body>
</html>
